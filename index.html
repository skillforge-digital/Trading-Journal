<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Skillforge Trading Journal — Student Dashboard & Admin Panel">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg">
    <title>Skillforge Trading Journal</title>

    <!-- Preconnect -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://unpkg.com" crossorigin />

    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase Compat SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>

    <!-- Lightweight Charts (Better for Custom Deriv Data) -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .ticker-scroll::-webkit-scrollbar { display: none; }
        .ticker-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        .hidden { display: none !important; }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .profit-text { color: #4ade80; }
        .loss-text { color: #f87171; }

        @keyframes pulse-dot {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .live-indicator {
            width: 8px; height: 8px; background-color: #4ade80; border-radius: 50%; animation: pulse-dot 2s infinite;
        }

        .modal {
            display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.active {
            display: flex; opacity: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        select option, select optgroup { background-color: #0f172a; color: white; }
        input, select, textarea, button { font-size: 16px; } /* iOS zoom fix */
        
        .touch-scroll { -webkit-overflow-scrolling: touch; }
        
        .logo-img { object-fit: cover; }

        /* Password Eye */
        .password-container { position: relative; }
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #64748b;
        }
        .password-toggle:hover { color: #94a3b8; }
    </style>
</head>
<body class="pb-10 bg-slate-950 text-white">
    <canvas id="space-background" class="fixed inset-0 z-[-1] pointer-events-none"></canvas>

    <noscript>
        <div class="fixed inset-0 z-[300] flex items-center justify-center bg-red-900/80">
            <div class="max-w-lg p-6 bg-slate-900 rounded-2xl">
                <h2 class="text-lg font-bold">JavaScript required</h2>
                <p class="mt-2 text-sm text-slate-300">This application requires JavaScript to run.</p>
            </div>
        </div>
    </noscript>

    <!-- ================= AUTH CONTAINER ================= -->
    <div id="authContainer" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-950/95 backdrop-blur-xl" role="dialog" aria-modal="true">
        <div class="glass w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl flex flex-col relative border border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="p-8 pb-0 text-center">
                <div class="inline-flex items-center justify-center w-24 h-24 mb-5 shadow-2xl shadow-blue-900/50">
                    <img src="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg" alt="Skillforge Logo" class="w-full h-full rounded-2xl logo-img">
                </div>
                <h1 id="authTitle" class="text-2xl md:text-3xl font-black tracking-tight mb-1">SKILLFORGE <span class="text-blue-500">DIGITAL</span></h1>
                <p class="text-blue-400 text-xs font-bold uppercase tracking-[0.2em]">Official Trading Journal</p>
            </div>

            <!-- Step 1: Landing Options -->
            <div id="landing-options" class="p-8 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-show-login" type="button" class="group p-6 bg-slate-900/50 border border-slate-800 rounded-2xl hover:bg-blue-600 hover:border-blue-500 transition-all text-left">
                        <div class="bg-slate-800 group-hover:bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors">
                            <i data-lucide="user" class="text-slate-400 group-hover:text-white w-5 h-5"></i>
                        </div>
                        <h3 class="font-bold text-white text-sm">Student Login</h3>
                        <p class="text-[10px] text-slate-500 group-hover:text-blue-200 mt-1">Access journal</p>
                    </button>

                    <button id="btn-show-register" type="button" class="group p-6 bg-slate-900/50 border border-slate-800 rounded-2xl hover:bg-blue-600 hover:border-blue-500 transition-all text-left">
                        <div class="bg-slate-800 group-hover:bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors">
                            <i data-lucide="user-plus" class="text-slate-400 group-hover:text-white w-5 h-5"></i>
                        </div>
                        <h3 class="font-bold text-white text-sm">New Student</h3>
                        <p class="text-[10px] text-slate-500 group-hover:text-blue-200 mt-1">Create account</p>
                    </button>
                </div>

                <div class="relative py-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
                    <div class="relative flex justify-center"><span class="bg-slate-900 px-2 text-[10px] text-slate-500 uppercase font-bold">Authorized Personnel</span></div>
                </div>

                <button id="btn-show-admin" type="button" class="w-full p-4 rounded-xl border border-slate-800 hover:bg-slate-800 transition-all flex items-center justify-center gap-2 group">
                    <i data-lucide="shield-check" class="text-slate-500 group-hover:text-red-500 w-4 h-4 transition-colors"></i>
                    <span class="text-xs font-bold text-slate-400 group-hover:text-white uppercase tracking-wider">Mentor Access</span>
                </button>
            </div>

            <!-- Step 2: Forms -->
            <div id="auth-forms" class="p-8 hidden">
                <div class="flex items-center gap-4 mb-6">
                    <button id="btn-back-auth" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors" type="button">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <h2 id="auth-title" class="text-xl font-bold text-white"></h2>
                </div>

                <!-- Student Form -->
                <form id="authForm" class="space-y-4 hidden" novalidate>
                    <div>
                        <label for="email" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Email Address</label>
                        <input type="email" id="email" name="email" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label for="password" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="password" name="password" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none transition-colors pr-10">
                            <i data-lucide="eye" class="password-toggle w-4 h-4" onclick="togglePassword('password', this)"></i>
                        </div>
                        <div id="forgotPasswordContainer" class="text-right mt-1 hidden">
                            <button type="button" onclick="handleForgotPassword()" class="text-[10px] text-blue-400 hover:text-blue-300 font-bold">Forgot Password?</button>
                        </div>
                    </div>
                    <button type="submit" id="btn-auth-action" class="w-full btn-primary py-3 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg shadow-blue-900/20 mt-2">
                        Proceed
                    </button>
                </form>

                <!-- Admin Form -->
                <form id="adminForm" class="space-y-4 hidden" novalidate>
                    <div>
                        <label for="adminPasscode" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Security Passcode</label>
                        <div class="relative">
                            <input type="password" id="adminPasscode" name="adminPasscode" placeholder="••••••••••••" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center pr-10">
                            <i data-lucide="eye" class="password-toggle w-4 h-4" onclick="togglePassword('adminPasscode', this)"></i>
                        </div>
                    </div>
                    <button type="submit" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg shadow-red-900/20 mt-2 transition-all">
                        Verify Identity
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================= STUDENT APP CONTENT ================= -->
    <div id="studentApp" class="hidden">
        <header class="glass sticky top-0 z-50 border-b border-slate-800 shadow-2xl">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg overflow-hidden border border-slate-700">
                            <img src="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg" alt="Logo" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-extrabold tracking-tight flex items-center gap-2">
                                SKILLFORGE <span class="text-blue-500">DIGITAL</span>
                            </h1>
                            <p class="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-bold">Student Dashboard</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 text-xs">
                            <div class="live-indicator"></div>
                            <span class="text-slate-400 font-medium">LIVE DATA</span>
                        </div>

                        <button id="btn-toggle-chart" type="button" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors" title="Toggle Chart">
                            <i data-lucide="layout-grid" class="w-5 h-5"></i>
                        </button>

                        <button id="btn-new-trade" type="button" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> NEW TRADE
                        </button>
                        
                        <button id="btn-export-csv" type="button" class="px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors">
                            <i data-lucide="download" class="w-4 h-4"></i> EXPORT
                        </button>

                        <button id="btn-logout" type="button" class="p-2 rounded-lg bg-red-900/20 hover:bg-red-900/40 text-red-400 transition-colors" title="Logout">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Market Ticker -->
                <div class="mt-4 flex items-center gap-3">
                    <div class="relative w-full max-w-xs">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500"></i>
                        <input type="text" id="marketSearch" placeholder="Search Assets..." class="w-full bg-slate-950 border border-slate-800 rounded-full py-1.5 pl-9 pr-4 text-xs text-white focus:outline-none focus:border-blue-500">
                    </div>
                    <div id="tickerContainer" class="flex gap-3 overflow-x-auto ticker-scroll flex-1 py-1"></div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 mt-8" id="main">
            <!-- Chart Section -->
            <section id="chartSection" class="mb-8">
                <div class="glass rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
                    <div class="p-3 bg-slate-900/50 flex justify-between items-center border-b border-slate-800">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Market Analysis</span>
                            <select id="chartSymbolSelector" class="bg-slate-950 border border-slate-800 rounded-lg px-2 py-1 text-xs text-white outline-none focus:border-blue-500">
                                <option value="">Loading Assets...</option>
                            </select>
                        </div>
                        <button id="btn-close-chart" type="button" class="text-slate-500 hover:text-white">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="chart-container" class="h-[500px] w-full relative bg-[#0f172a]"></div>
                </div>
            </section>

            <!-- Analytics Overview -->
            <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Realized PnL</p>
                    <h2 id="totalPnl" class="text-2xl font-black font-mono mt-1">$0.00</h2>
                </div>
                <div class="glass p-5 rounded-2xl border-l-4 border-green-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Win Rate</p>
                    <h2 id="winRate" class="text-2xl font-black font-mono mt-1">0%</h2>
                </div>
                <div class="glass p-5 rounded-2xl border-l-4 border-purple-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Total Lots</p>
                    <h2 id="totalLots" class="text-2xl font-black font-mono mt-1">0.00</h2>
                </div>
                <div class="glass p-5 rounded-2xl border-l-4 border-slate-500">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Active Trades</p>
                    <h2 id="activeCount" class="text-2xl font-black font-mono mt-1">0</h2>
                </div>
            </section>
            
            <!-- Logging Tabs -->
            <div class="flex flex-wrap gap-2 mb-6 bg-slate-900/50 p-1.5 rounded-2xl w-fit border border-slate-800">
                <button onclick="switchTab('active')" id="tab-active" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-blue-400">Active</button>
                <button onclick="switchTab('history')" id="tab-history" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Closed</button>
                <button onclick="switchTab('leaderboard')" id="tab-leaderboard" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Leaderboard</button>
                <button onclick="switchTab('feedback')" id="tab-feedback" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Feedback</button>
            </div>

            <!-- Views -->
            <div id="activeTradesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <div id="historyList" class="hidden overflow-x-auto glass rounded-2xl border border-slate-800">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50 grid grid-cols-1 md:grid-cols-5 gap-3">
                    <input id="filterInstrument" placeholder="Instrument" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
                    <select id="filterSide" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
                        <option value="">Side</option>
                        <option value="buy">Buy</option>
                        <option value="sell">Sell</option>
                    </select>
                    <input id="filterTag" placeholder="Tag" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
                    <input id="filterFrom" type="date" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
                    <input id="filterTo" type="date" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
                </div>
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-900/80 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-800">
                        <tr>
                            <th class="p-5">Instrument</th>
                            <th class="p-5">Side</th>
                            <th class="p-5">Lots</th>
                            <th class="p-5">Entry / Close</th>
                            <th class="p-5">Pips</th>
                            <th class="p-5 text-right">PnL</th>
                            <th class="p-5"></th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-800/50"></tbody>
                </table>
            </div>

            <div id="leaderboardList" class="hidden">
                <div class="glass rounded-2xl overflow-hidden border border-slate-800 max-w-2xl mx-auto">
                    <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3">
                        <i data-lucide="trophy" class="text-yellow-500 w-5 h-5"></i>
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Top Traders</h3>
                    </div>
                    <div id="leaderboardContent" class="p-5 space-y-3">
                        <p class="text-slate-500 text-sm text-center">Loading leaderboard...</p>
                    </div>
                </div>
            </div>

            <div id="feedbackList" class="hidden">
                <div class="glass rounded-2xl overflow-hidden border border-slate-800 max-w-2xl mx-auto">
                    <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3">
                        <i data-lucide="message-circle" class="text-blue-500 w-5 h-5"></i>
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Instructor Feedback</h3>
                    </div>
                    <div id="feedbackContent" class="p-5 space-y-4">
                        <p class="text-slate-500 text-sm text-center">Loading feedback...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ================= ADMIN APP CONTENT ================= -->
    <div id="adminApp" class="hidden">
        <header class="glass sticky top-0 z-50 border-b border-slate-800 shadow-2xl">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-red-600 p-2 rounded-lg">
                        <i data-lucide="shield" class="text-white w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-extrabold tracking-tight text-white">
                            SKILLFORGE <span class="text-red-500">ADMIN</span>
                        </h1>
                    </div>
                </div>
                <button id="btn-admin-logout" class="text-slate-400 hover:text-white text-sm font-bold uppercase">Log Out</button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 mt-8 grid grid-cols-1 md:grid-cols-4 gap-6 relative">
            <!-- Sidebar: Student List -->
            <aside class="glass rounded-2xl overflow-hidden h-[80vh] flex flex-col sticky top-24">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                    <h3 class="text-sm font-bold text-white uppercase">Students</h3>
                </div>
                <div id="studentList" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar touch-scroll">
                    <p class="text-center text-slate-500 text-xs mt-4">Loading students...</p>
                </div>
            </aside>

            <!-- Main: Student Logs -->
            <section class="md:col-span-3 space-y-6">
                <!-- Selected Student Info -->
                <div id="studentHeader" class="glass p-6 rounded-2xl border-l-4 border-blue-500 hidden">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 id="studentEmail" class="text-2xl font-bold text-white">Select a Student</h2>
                            <p class="text-slate-500 text-xs uppercase tracking-widest mt-1">Student ID: <span id="studentId">---</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-slate-500 uppercase">Total Profit</p>
                            <h3 id="adminTotalPnl" class="text-2xl font-black font-mono text-white">$0.00</h3>
                        </div>
                    </div>
                </div>

                <!-- Trades Table -->
                <div class="glass rounded-2xl overflow-hidden min-h-[400px]">
                    <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-white uppercase">Trade Log</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="refreshTrades()" class="text-slate-400 hover:text-white"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-900/80 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-800">
                                <tr>
                                    <th class="p-5">Time</th>
                                    <th class="p-5">Asset</th>
                                    <th class="p-5">Type</th>
                                    <th class="p-5">Lots</th>
                                    <th class="p-5">PnL</th>
                                    <th class="p-5">Status</th>
                                </tr>
                            </thead>
                            <tbody id="adminTradeTable" class="divide-y divide-slate-800/50">
                                <tr>
                                    <td colspan="6" class="p-8 text-center text-slate-500 text-sm font-bold uppercase tracking-wider opacity-50">Select a student to view trades.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feedback Section -->
                <div id="feedbackSection" class="glass p-6 rounded-2xl hidden border border-slate-700">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-lucide="message-square" class="text-blue-500 w-5 h-5"></i>
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider">Mentor Feedback & Notes</h3>
                    </div>
                    
                    <div id="commentsList" class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2 custom-scrollbar touch-scroll"></div>
                    
                    <form id="commentForm" class="flex gap-3">
                        <input type="text" id="commentInput" placeholder="Write a constructive comment..." class="flex-1 bg-slate-950 border border-slate-800 rounded-xl p-4 text-white focus:border-blue-500 outline-none text-sm transition-colors">
                        <button type="submit" class="btn-primary px-8 rounded-xl font-bold text-xs uppercase tracking-wider shadow-lg shadow-blue-900/20 hover:scale-105 transition-transform">Send</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- ================= MODALS ================= -->
    <div id="tradeModal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md hidden" role="dialog" aria-modal="true">
        <div class="glass w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border border-slate-700">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                <h3 id="tradeModalTitle" class="text-sm font-bold text-white tracking-widest uppercase">New Trade Entry</h3>
                <button id="tradeModalClose" type="button" class="text-slate-500 hover:text-white icon-button" aria-label="Close">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="tradeForm" class="p-6 space-y-5" novalidate>
                <div>
                    <label for="f-instrument" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Asset Selection</label>
                    <input type="text" id="instrumentFilter" placeholder="Type to filter..." class="w-full bg-slate-900 border border-slate-800 rounded-xl p-2 mb-2 text-xs text-white outline-none focus:border-blue-500">
                    <div class="relative">
                        <select id="f-instrument" name="instrument" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-bold outline-none focus:border-blue-500 appearance-none"></select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none"></i>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Direction</label>
                        <div class="flex bg-slate-950 p-1.5 rounded-xl border border-slate-800">
                            <button type="button" onclick="setSide('buy')" id="btn-buy" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase bg-green-600 text-white shadow-lg">BUY</button>
                            <button type="button" onclick="setSide('sell')" id="btn-sell" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase text-slate-500">SELL</button>
                        </div>
                    </div>
                    <div>
                        <label for="f-lots" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Lot Size</label>
                        <input type="number" step="0.01" id="f-lots" name="lots" placeholder="0.01" required class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-bold outline-none focus:border-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="f-entry" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Entry Price</label>
                        <input type="number" step="any" id="f-entry" name="entryPrice" placeholder="0.0000" required class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label for="f-sl" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Stop Loss</label>
                        <input type="number" step="any" id="f-sl" name="stopLoss" placeholder="0.0000" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-red-500">
                    </div>
                </div>
                
                 <div>
                    <label for="f-tp" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Take Profit</label>
                    <input type="number" step="any" id="f-tp" name="takeProfit" placeholder="0.0000" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-green-500">
                </div>

                <div>
                    <label for="f-setup" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Setup / Strategy</label>
                    <input type="text" id="f-setup" name="setup" placeholder="e.g. Break and Retest" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-blue-500">
                </div>

                <button type="submit" class="w-full btn-primary py-4 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg shadow-blue-900/20">
                    Execute Trade
                </button>
            </form>
        </div>
    </div>

    <!-- Edit/Close Modal -->
    <div id="editModal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md hidden" role="dialog" aria-modal="true">
        <div class="glass w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl border border-slate-700">
            <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                <h3 class="text-sm font-bold text-white uppercase tracking-wider">Manage Trade</h3>
                <button onclick="closeEditModal()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Close Price</label>
                    <input type="number" step="any" id="e-closePrice" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
                </div>
                <button onclick="confirmCloseTrade()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold text-xs uppercase tracking-wider">
                    Close Position
                </button>
                <div class="pt-4 border-t border-slate-800">
                    <button onclick="deleteTrade()" class="w-full py-3 bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/30 rounded-xl font-bold text-xs uppercase tracking-wider">
                        Delete Record
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SERVICE WORKER REGISTRATION (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful');
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // --- CONFIGURATION ---
        const ADMIN_PASSCODE = '#skillmindset#';
        
        const firebaseConfig = {
            apiKey: "AIzaSyA28jc1OxMfc33m7rk8fCrfgmnw_uLzc50",
            authDomain: "trading-journal-914c4.firebaseapp.com",
            projectId: "trading-journal-914c4",
            storageBucket: "trading-journal-914c4.firebasestorage.app",
            messagingSenderId: "504948935584",
            appId: "1:504948935584:web:dbf3c74177c07941785f7c",
            measurementId: "G-1234567890"
        };

        // --- APP STATE ---
        let db, auth;
        let marketData = [];
        let trades = [];
        let tradeSide = 'buy';
        let currentTab = 'active';
        let currentEditTradeId = null;
        let derivWS = null;
        let selectedStudentId = null; 
        let lastFilter = '';
        
        // Charting
        let chart = null;
        let candleSeries = null;
        let currentChartSymbol = 'R_100'; // Default
        let lastCandle = null;

        // Audio Context for Alarm
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let alarmInterval = null;

        // Init Firebase
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error('Firebase Error:', e);
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('App Initializing...');
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Restore Last Tab
            const lastTab = localStorage.getItem('skillforge_last_tab') || 'active';
            switchTab(lastTab);

            setupUIListeners();
            setupAuthListeners();
            initDerivConnection();

            // Init Chart (Lightweight Charts)
            initChart();
            
            // Init Space Background
            initSpaceBackground();

            // Start Alarm Checker
            setInterval(checkTradeAlarms, 30000); // Check every 30s

            // Network handling
            window.addEventListener('online', () => {
                showNotification('Network connected.', 'success');
                initDerivConnection();
            });
            window.addEventListener('offline', () => showNotification('Network lost.', 'error'));
        });

        // --- SPACE BACKGROUND ---
        function initSpaceBackground() {
            const canvas = document.getElementById('space-background');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let stars = [];
            const numStars = 150;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                initStars();
            }

            function initStars() {
                stars = [];
                for(let i=0; i<numStars; i++) {
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        z: Math.random() * 0.5 + 0.1, // Speed
                        size: Math.random() * 1.5,
                        opacity: Math.random()
                    });
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                stars.forEach(star => {
                    ctx.beginPath();
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Move
                    star.y -= star.z; // Move up like floating in space
                    
                    // Reset
                    if(star.y < 0) {
                        star.y = canvas.height;
                        star.x = Math.random() * canvas.width;
                    }
                });
                
                requestAnimationFrame(animate);
            }

            window.addEventListener('resize', resize);
            resize();
            animate();
        }

        // --- CHARTING (Lightweight Charts) ---
        function initChart() {
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 500,
                layout: {
                    background: { color: '#0f172a' },
                    textColor: '#94a3b8',
                },
                grid: {
                    vertLines: { color: '#1e293b' },
                    horzLines: { color: '#1e293b' },
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#22c55e',
                downColor: '#ef4444',
                borderVisible: false,
                wickUpColor: '#22c55e',
                wickDownColor: '#ef4444',
            });

            // Resize handler
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== container) { return; }
                const newRect = entries[0].contentRect;
                chart.applyOptions({ height: newRect.height, width: newRect.width });
            }).observe(container);
            
            // Selector listener
            document.getElementById('chartSymbolSelector').addEventListener('change', (e) => {
                currentChartSymbol = e.target.value;
                requestChartData(currentChartSymbol);
            });
        }

        function requestChartData(symbol) {
             if (derivWS && derivWS.readyState === 1) {
                 // Request last 1000 candles (1h interval for journal overview)
                 derivWS.send(JSON.stringify({ 
                     ticks_history: symbol, 
                     adjust_start_time: 1, 
                     count: 100, 
                     end: "latest", 
                     start: 1, 
                     style: "candles", 
                     granularity: 3600 // 1 hour
                 }));
             }
        }

        // --- DERIV WEBSOCKET ---
        function initDerivConnection() {
            if (derivWS && derivWS.readyState === 1) return;
            
            console.log('Connecting to Deriv...');
            derivWS = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
            
            derivWS.onopen = () => {
                console.log('Deriv Connected');
                setConnectionStatus(true);
                
                // Get Active Symbols
                derivWS.send(JSON.stringify({ active_symbols: "brief", product_type: "basic" }));
                
                // Keepalive
                setInterval(() => { if(derivWS.readyState===1) derivWS.send(JSON.stringify({ ping: 1 })); }, 30000);
                
                // Init Chart Data
                requestChartData(currentChartSymbol);
            };

            derivWS.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                
                if (data.msg_type === 'active_symbols') {
                    marketData = data.active_symbols.map(s => ({
                        symbol: s.display_name,
                        deriv: s.symbol,
                        market: s.market_display_name,
                        price: 0
                    }));
                    populateInstruments();
                    
                    // Subscribe to ticks for prices
                    const ticks = marketData.slice(0, 50).map(m => m.deriv);
                    derivWS.send(JSON.stringify({ ticks: ticks }));
                
                } else if (data.msg_type === 'tick') {
                    updatePrice(data.tick);
                
                } else if (data.msg_type === 'candles') {
                    // Initial Chart Load
                    const candles = data.candles.map(c => ({
                        time: c.epoch,
                        open: c.open,
                        high: c.high,
                        low: c.low,
                        close: c.close
                    }));
                    candleSeries.setData(candles);
                    lastCandle = candles[candles.length - 1];
                    // Subscribe to real-time candle updates? No, ticks update the candle locally or just subscribe to OHLC
                    // For simplicity in this demo, we just poll or rely on static load. 
                    // To make it live, we would need to subscribe. 
                    // Let's subscribe to current tick to update last candle
                
                } else if (data.msg_type === 'history') {
                    // Fallback if candles not available
                }
            };

            derivWS.onclose = () => {
                setConnectionStatus(false);
                setTimeout(initDerivConnection, 5000);
            };
        }

        function updatePrice(tick) {
            const m = marketData.find(x => x.deriv === tick.symbol);
            if (m) {
                m.price = tick.quote;
                
                // Update Chart if symbol matches
                if (tick.symbol === currentChartSymbol && candleSeries && lastCandle) {
                    const price = tick.quote;
                    // Update OHLC
                    if (price > lastCandle.high) lastCandle.high = price;
                    if (price < lastCandle.low) lastCandle.low = price;
                    lastCandle.close = price;
                    candleSeries.update(lastCandle);
                }

                // Check Alarms for Active Trades
                checkPriceAlarms(m.symbol, tick.quote);
                
                renderTicker(); 
            }
        }

        // --- ALARM SYSTEM ---
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.value = 880; // A5
            gainNode.gain.value = 0.1;
            oscillator.start();
            setTimeout(() => oscillator.stop(), 200);
        }

        function checkTradeAlarms() {
            // 1. Time Alarm: Check trades open for > 1 hour
            const now = Date.now();
            trades.forEach(t => {
                if (t.status === 'open') {
                    const openTime = t.openTime.toMillis ? t.openTime.toMillis() : t.openTime.seconds * 1000;
                    const diffHrs = (now - openTime) / (1000 * 60 * 60);
                    
                    if (diffHrs >= 1 && diffHrs < 1.01) { // Trigger once around the 1hr mark
                         showNotification(`Trade ${t.instrument} open for 1 hour. Check Setup!`, 'warning');
                         playBeep();
                    }
                }
            });
        }

        function checkPriceAlarms(symbol, currentPrice) {
            // 2. Proximity Alarm: 70% to SL or TP
            trades.forEach(t => {
                if (t.status === 'open' && t.instrument === symbol) {
                    // Calculate Distances
                    const distToEntry = Math.abs(currentPrice - t.entryPrice);
                    
                    // SL Check
                    if (t.stopLoss) {
                        const totalDistSL = Math.abs(t.entryPrice - t.stopLoss);
                        const currentDistSL = Math.abs(currentPrice - t.stopLoss);
                        
                        // If 70% of the way to SL (meaning 30% remaining)
                        // Or if 30% of total distance is left
                        if (currentDistSL <= totalDistSL * 0.3) {
                             // Throttle this in real app
                             // console.log('Approaching SL');
                             // playBeep(); // Be careful not to spam
                        }
                    }
                }
            });
        }

        // --- AUTH LOGIC ---
        function setupUIListeners() {
            const bind = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('click', fn); };
            
            bind('btn-show-login', () => showAuthForm('login'));
            bind('btn-show-register', () => showAuthForm('register'));
            bind('btn-show-admin', () => showAuthForm('admin'));
            bind('btn-back-auth', resetAuthView);
            
            document.getElementById('authForm').onsubmit = handleStudentAuth;
            document.getElementById('adminForm').onsubmit = handleAdminAuth;
            document.getElementById('tradeForm').onsubmit = handleTradeSubmit;
            document.getElementById('commentForm').onsubmit = handleAdminComment;
            
            bind('btn-logout', logout);
            bind('btn-admin-logout', logout);
            bind('btn-new-trade', openModal);
            bind('tradeModalClose', closeModal);
            bind('btn-toggle-chart', toggleChart);
            bind('btn-close-chart', toggleChart);
            bind('btn-export-csv', exportCSV);
            
            // Market Search
            const marketSearch = document.getElementById('marketSearch');
            if (marketSearch) {
                marketSearch.addEventListener('input', (e) => {
                    renderTicker(e.target.value);
                });
            }
            
            // Trade Instrument Filter
            const instrumentFilter = document.getElementById('instrumentFilter');
            if(instrumentFilter) {
                instrumentFilter.addEventListener('input', (e) => filterTradeInstruments(e.target.value));
            }

            // Resume Audio Context on first interaction
            document.body.addEventListener('click', () => { 
                if (audioCtx.state === 'suspended') audioCtx.resume(); 
            }, { once: true });

            // Filters
            ['filterInstrument', 'filterSide', 'filterTag', 'filterFrom', 'filterTo'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('input', renderHistory);
                    el.addEventListener('change', renderHistory);
                }
            });
        }

        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('text-slate-500');
                icon.classList.add('text-blue-500');
            } else {
                input.type = "password";
                icon.classList.add('text-slate-500');
                icon.classList.remove('text-blue-500');
            }
        }

        function handleForgotPassword() {
            const email = document.getElementById('email').value;
            if (!email) {
                showNotification('Please enter your email first.', 'error');
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => showNotification('Reset link sent to ' + email, 'success'))
                .catch(err => showNotification(err.message, 'error'));
        }

        function setupAuthListeners() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    console.log('User:', user.email);
                    document.getElementById('authContainer').classList.add('hidden');
                    document.getElementById('studentApp').classList.remove('hidden');
                    loadUserTrades(user.uid);
                    loadLeaderboard();
                    loadFeedback();
                    
                    db.collection('users').doc(user.uid).set({
                        email: user.email,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                } else {
                    document.getElementById('authContainer').classList.remove('hidden');
                    document.getElementById('studentApp').classList.add('hidden');
                    document.getElementById('adminApp').classList.add('hidden');
                    resetAuthView();
                }
            });
        }

        function showAuthForm(type) {
            document.getElementById('landing-options').classList.add('hidden');
            document.getElementById('auth-forms').classList.remove('hidden');
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('adminForm').classList.add('hidden');
            document.getElementById('forgotPasswordContainer').classList.add('hidden');
            
            if (type === 'admin') {
                document.getElementById('adminForm').classList.remove('hidden');
                document.getElementById('auth-title').innerText = 'Mentor Access';
            } else {
                document.getElementById('authForm').classList.remove('hidden');
                document.getElementById('authForm').dataset.mode = type;
                document.getElementById('auth-title').innerText = type === 'register' ? 'Student Registration' : 'Student Login';
                document.getElementById('btn-auth-action').innerText = type === 'register' ? 'Create Account' : 'Access Journal';
                
                if (type === 'login') {
                    document.getElementById('forgotPasswordContainer').classList.remove('hidden');
                }
            }
        }

        function resetAuthView() {
            document.getElementById('landing-options').classList.remove('hidden');
            document.getElementById('auth-forms').classList.add('hidden');
            document.getElementById('authForm').reset();
            document.getElementById('adminForm').reset();
        }

        async function handleStudentAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const mode = e.target.dataset.mode;

            try {
                if (mode === 'register') {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showNotification('Account created!', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    showNotification('Welcome back!', 'success');
                }
            } catch (err) {
                showNotification(err.message, 'error');
            }
        }

        function handleAdminAuth(e) {
            e.preventDefault();
            const code = document.getElementById('adminPasscode').value;
            if (code === ADMIN_PASSCODE) {
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('studentApp').classList.add('hidden');
                document.getElementById('adminApp').classList.remove('hidden');
                loadStudents(); 
            } else {
                showNotification('Invalid Passcode', 'error');
            }
        }

        function logout() {
            auth.signOut().then(() => showNotification('Logged out', 'success'));
        }

        // --- FIRESTORE LOGIC (Preserved) ---
        function loadUserTrades(uid) {
            db.collection('users').doc(uid).collection('trades')
              .orderBy('openTime', 'desc')
              .onSnapshot(snap => {
                  trades = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  updateStats();
                  renderActiveTrades();
                  renderHistory();
              });
        }

        async function handleTradeSubmit(e) {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            const f = e.target;
            const trade = {
                instrument: f.instrument.value,
                type: tradeSide,
                lots: parseFloat(f.lots.value),
                entryPrice: parseFloat(f.entryPrice.value),
                stopLoss: f.stopLoss.value ? parseFloat(f.stopLoss.value) : null,
                takeProfit: f.takeProfit.value ? parseFloat(f.takeProfit.value) : null,
                setup: f.setup.value,
                openTime: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'open',
                pnl: 0
            };
            try {
                await db.collection('users').doc(user.uid).collection('trades').add(trade);
                showNotification('Trade executed', 'success');
                closeModal();
                f.reset();
            } catch (err) {
                showNotification(err.message, 'error');
            }
        }
        
        // --- ADMIN FUNCTIONS ---
        async function loadStudents() {
            const list = document.getElementById('studentList');
            try {
                const snap = await db.collection('users').get();
                if (snap.empty) {
                    list.innerHTML = '<p class="text-center text-slate-500 text-xs mt-4">No students found.</p>';
                    return;
                }
                list.innerHTML = snap.docs.map(doc => {
                    const data = doc.data();
                    const email = data.email || 'Unknown';
                    const colors = ['bg-blue-600', 'bg-purple-600', 'bg-green-600', 'bg-yellow-600'];
                    const bg = colors[email.charCodeAt(0) % colors.length];
                    return `
                        <div onclick="selectStudent('${doc.id}', '${email}')" class="p-3 rounded-lg hover:bg-slate-800 cursor-pointer transition-colors border border-transparent hover:border-slate-700 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${bg} flex items-center justify-center text-xs font-bold text-white shadow-lg shrink-0">${email.substring(0,2).toUpperCase()}</div>
                            <div class="overflow-hidden">
                                <p class="text-xs font-bold text-slate-300 truncate">${email}</p>
                                <p class="text-[10px] text-slate-500 truncate font-mono">${doc.id.slice(0,6)}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error(err);
                showNotification('Error loading students', 'error');
            }
        }

        function selectStudent(uid, email) {
            selectedStudentId = uid;
            document.getElementById('studentHeader').classList.remove('hidden');
            document.getElementById('feedbackSection').classList.remove('hidden');
            document.getElementById('studentEmail').innerText = email;
            document.getElementById('studentId').innerText = uid;
            
            db.collection('users').doc(uid).collection('trades').orderBy('openTime', 'desc').onSnapshot(snap => {
                const tList = snap.docs.map(d => d.data());
                const total = tList.reduce((acc, t) => acc + (t.status === 'closed' ? t.pnl : 0), 0);
                document.getElementById('adminTotalPnl').innerText = `$${total.toFixed(2)}`;
                
                const tbody = document.getElementById('adminTradeTable');
                if(tList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500">No trades.</td></tr>';
                } else {
                    tbody.innerHTML = tList.map(t => `
                        <tr class="hover:bg-slate-800/30 border-b border-slate-800/50">
                            <td class="p-4 text-xs text-slate-400">${t.openTime ? new Date(t.openTime.seconds*1000).toLocaleDateString() : '-'}</td>
                            <td class="p-4 text-xs font-bold text-white">${t.instrument}</td>
                            <td class="p-4 text-xs uppercase ${t.type === 'buy' ? 'text-green-400' : 'text-red-400'}">${t.type}</td>
                            <td class="p-4 text-xs font-mono">${t.lots}</td>
                            <td class="p-4 text-xs font-mono font-bold ${t.pnl>=0?'profit-text':'loss-text'}">$${t.pnl.toFixed(2)}</td>
                            <td class="p-4 text-[10px] uppercase font-bold text-slate-500">${t.status}</td>
                        </tr>
                    `).join('');
                }
            });

            db.collection('users').doc(uid).collection('comments').orderBy('createdAt', 'desc').onSnapshot(snap => {
                const list = document.getElementById('commentsList');
                if(snap.empty) {
                    list.innerHTML = '<p class="text-xs text-slate-500 italic">No feedback yet.</p>';
                } else {
                    list.innerHTML = snap.docs.map(d => {
                        const c = d.data();
                        return `<div class="bg-slate-900/50 p-3 rounded-lg border border-slate-800"><p class="text-xs text-slate-300">${c.text}</p><p class="text-[9px] text-slate-600 mt-1 text-right">${c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleString() : ''}</p></div>`;
                    }).join('');
                }
            });
        }

        async function handleAdminComment(e) {
            e.preventDefault();
            if(!selectedStudentId) return;
            const text = document.getElementById('commentInput').value.trim();
            if(!text) return;
            await db.collection('users').doc(selectedStudentId).collection('comments').add({
                text: text,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                author: 'Admin'
            });
            document.getElementById('commentInput').value = '';
            showNotification('Feedback sent', 'success');
        }

        function refreshTrades() {
            if(selectedStudentId) selectStudent(selectedStudentId, document.getElementById('studentEmail').innerText);
        }

        // --- SHARED UTILS ---
        function setConnectionStatus(online) {
            const el = document.getElementById('connectionStatus');
            if (online) {
                el.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 text-xs";
                el.innerHTML = '<div class="live-indicator"></div><span class="text-slate-400 font-medium">LIVE DATA</span>';
            } else {
                el.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-900/20 border border-red-900/50 text-xs";
                el.innerHTML = '<div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-red-400 font-medium">OFFLINE</span>';
            }
        }

        function filterTradeInstruments(term) {
            const s = document.getElementById('f-instrument');
            const lower = term.toLowerCase();
            const groups = {};
            
            marketData.forEach(m => {
                if (m.symbol.toLowerCase().includes(lower) || m.market.toLowerCase().includes(lower)) {
                    if (!groups[m.market]) groups[m.market] = [];
                    groups[m.market].push(m);
                }
            });
            
            s.innerHTML = Object.keys(groups).sort().map(cat => `
                <optgroup label="${cat}">
                    ${groups[cat].map(m => `<option value="${m.symbol}">${m.symbol}</option>`).join('')}
                </optgroup>
            `).join('');
            
            if(s.options.length > 0) {
                 s.selectedIndex = 0;
                 s.dispatchEvent(new Event('change'));
            }
        }

        function populateInstruments() {
            const s = document.getElementById('f-instrument');
            const c = document.getElementById('chartSymbolSelector');
            const groups = {};
            marketData.forEach(m => {
                if (!groups[m.market]) groups[m.market] = [];
                groups[m.market].push(m);
            });
            
            // Trade Modal Select (Value = Display Name)
            s.innerHTML = Object.keys(groups).sort().map(cat => `
                <optgroup label="${cat}">
                    ${groups[cat].map(m => `<option value="${m.symbol}">${m.symbol}</option>`).join('')}
                </optgroup>
            `).join('');
            
            // Chart Selector (Value = API Symbol)
            if(c) {
                c.innerHTML = Object.keys(groups).sort().map(cat => `
                    <optgroup label="${cat}">
                        ${groups[cat].map(m => `<option value="${m.deriv}">${m.symbol}</option>`).join('')}
                    </optgroup>
                `).join('');
                // Set initial value if matches
                if(currentChartSymbol && Array.from(c.options).some(o => o.value === currentChartSymbol)) {
                    c.value = currentChartSymbol;
                }
            }

            s.addEventListener('change', () => {
                 const m = marketData.find(x => x.symbol === s.value);
                 if(m && m.price) document.getElementById('f-entry').value = m.price;
            });
        }

        function renderTicker(filterText = null) {
            const c = document.getElementById('tickerContainer');
            const searchInput = document.getElementById('marketSearch');
            const currentFilter = filterText !== null ? filterText : (searchInput ? searchInput.value : '');
            
            // Rebuild if filter changed or empty
            if (currentFilter !== lastFilter || c.childElementCount === 0) {
                lastFilter = currentFilter;
                const filtered = currentFilter 
                    ? marketData.filter(m => m.symbol.toLowerCase().includes(currentFilter.toLowerCase()) || m.deriv.toLowerCase().includes(currentFilter.toLowerCase()))
                    : marketData;
                    
                c.innerHTML = filtered.slice(0, 20).map(m => `
                    <div class="flex-shrink-0 px-3 py-1.5 bg-slate-900 rounded-lg border border-slate-800 flex items-center gap-2 min-w-[120px]" onclick="selectTickerInstrument('${m.deriv}')" style="cursor:pointer">
                        <span class="text-[10px] font-bold text-slate-400">${m.symbol}</span>
                        <span class="text-xs font-mono font-bold text-white" id="price-${m.deriv}">${m.price}</span>
                    </div>
                `).join('');
            } else {
                // Update visible prices
                const filtered = currentFilter 
                    ? marketData.filter(m => m.symbol.toLowerCase().includes(currentFilter.toLowerCase()) || m.deriv.toLowerCase().includes(currentFilter.toLowerCase()))
                    : marketData;
                    
                filtered.slice(0, 20).forEach(m => {
                    const el = document.getElementById(`price-${m.deriv}`);
                    if(el) el.innerText = m.price;
                });
            }
        }
        
        function selectTickerInstrument(symbol) {
            const c = document.getElementById('chartSymbolSelector');
            if(c) {
                // Ensure option exists for old-style selector
                if (!Array.from(c.options).some(o => o.value === symbol)) {
                     const m = marketData.find(x => x.deriv === symbol);
                     const opt = document.createElement('option');
                     opt.value = symbol;
                     opt.text = m ? m.symbol : symbol;
                     c.add(opt);
                }
                c.value = symbol;
                c.dispatchEvent(new Event('change'));
                document.getElementById('chartSection').classList.remove('hidden');
                // Scroll to chart
                document.getElementById('chartSection').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            localStorage.setItem('skillforge_last_tab', tab); // Remember tab
            ['active', 'history', 'leaderboard', 'feedback'].forEach(t => {
                const b = document.getElementById(`tab-${t}`);
                if (t === tab) b.className = "px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-blue-400 shadow-lg border border-slate-700";
                else b.className = "px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300";
            });

            document.getElementById('activeTradesList').classList.add('hidden');
            document.getElementById('historyList').classList.add('hidden');
            document.getElementById('leaderboardList').classList.add('hidden');
            document.getElementById('feedbackList').classList.add('hidden');

            if (tab === 'active') {
                document.getElementById('activeTradesList').classList.remove('hidden');
                renderActiveTrades();
            } else if (tab === 'history') {
                document.getElementById('historyList').classList.remove('hidden');
                renderHistory();
            } else if (tab === 'leaderboard') {
                document.getElementById('leaderboardList').classList.remove('hidden');
                loadLeaderboard();
            } else if (tab === 'feedback') {
                document.getElementById('feedbackList').classList.remove('hidden');
                loadFeedback();
            }
        }

        function renderActiveTrades() {
            const list = document.getElementById('activeTradesList');
            const active = trades.filter(t => t.status === 'open');
            document.getElementById('activeCount').innerText = active.length;
            if (active.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center p-10 text-slate-500 text-sm">No active trades running.</div>';
                return;
            }
            list.innerHTML = active.map(t => `
                <div class="glass p-5 rounded-2xl border-l-4 ${t.type === 'buy' ? 'border-green-500' : 'border-red-500'} hover:bg-slate-900/60 transition-colors cursor-pointer" onclick="openEdit('${t.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-white">${t.instrument}</h3>
                            <span class="text-[10px] font-black uppercase ${t.type === 'buy' ? 'text-green-400 bg-green-500/10' : 'text-red-400 bg-red-500/10'} px-2 py-0.5 rounded">${t.type}</span>
                        </div>
                        <span class="text-xs font-mono text-slate-400">#${t.id.slice(0,4)}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-3">
                        <div>Entry: <span class="text-white font-mono">${t.entryPrice}</span></div>
                        <div>Lots: <span class="text-white font-mono">${t.lots}</span></div>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t border-slate-800">
                        <span class="text-[10px] uppercase font-bold text-slate-500">Running PnL</span>
                        <span class="font-mono font-bold text-sm text-white">...</span>
                    </div>
                </div>
            `).join('');
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTableBody');
            const history = trades.filter(t => t.status === 'closed');
            const fInst = document.getElementById('filterInstrument').value.toLowerCase();
            const fSide = document.getElementById('filterSide').value;
            
            const filtered = history.filter(t => 
                (!fInst || t.instrument.toLowerCase().includes(fInst)) &&
                (!fSide || t.type === fSide)
            );

            tbody.innerHTML = filtered.map(t => `
                <tr class="hover:bg-slate-800/30 border-b border-slate-800/50 transition-colors">
                    <td class="p-4">
                        <div class="font-bold text-xs text-white">${t.instrument}</div>
                        <div class="text-[10px] text-slate-500">${new Date(t.openTime.seconds*1000).toLocaleDateString()}</div>
                    </td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-[9px] font-black uppercase ${t.type === 'buy' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${t.type}</span></td>
                    <td class="p-4 text-xs font-mono text-slate-400">${t.lots}</td>
                    <td class="p-4">
                        <div class="text-[10px] text-slate-400">In: ${t.entryPrice}</div>
                        <div class="text-[10px] text-slate-400">Out: ${t.closePrice}</div>
                    </td>
                    <td class="p-4 text-xs font-mono text-slate-500">-</td>
                    <td class="p-4 text-xs font-mono font-bold ${t.pnl >= 0 ? 'profit-text' : 'loss-text'} text-right">$${t.pnl.toFixed(2)}</td>
                    <td class="p-4 text-right">
                         <button class="text-slate-600 hover:text-white"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function updateStats() {
            const closed = trades.filter(t => t.status === 'closed');
            const totalPnl = closed.reduce((acc, t) => acc + t.pnl, 0);
            const wins = closed.filter(t => t.pnl > 0).length;
            const winRate = closed.length ? Math.round((wins / closed.length) * 100) : 0;
            const totalLots = trades.reduce((acc, t) => acc + t.lots, 0);

            document.getElementById('totalPnl').innerText = `$${totalPnl.toFixed(2)}`;
            document.getElementById('totalPnl').className = `text-2xl font-black font-mono mt-1 ${totalPnl >= 0 ? 'profit-text' : 'loss-text'}`;
            document.getElementById('winRate').innerText = `${winRate}%`;
            document.getElementById('totalLots').innerText = totalLots.toFixed(2);
        }

        function openEdit(id) {
            currentEditTradeId = id;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('active');
        }
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editModal').classList.add('hidden');
        }
        function openModal() {
            document.getElementById('tradeModal').classList.remove('hidden');
            document.getElementById('tradeModal').classList.add('active');
            
            // Reset Filter
            const filter = document.getElementById('instrumentFilter');
            if(filter) {
                filter.value = '';
                filterTradeInstruments('');
            }
        }
        function closeModal() {
            document.getElementById('tradeModal').classList.remove('active');
            document.getElementById('tradeModal').classList.add('hidden');
        }
        function toggleChart() {
            const s = document.getElementById('chartSection');
            s.classList.toggle('hidden');
            if(!s.classList.contains('hidden') && chart) {
                // Trigger resize
                chart.timeScale().fitContent();
            }
        }
        function setSide(s) {
            tradeSide = s;
            document.getElementById('btn-buy').className = s === 'buy' ? "flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase bg-green-600 text-white shadow-lg" : "flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase text-slate-500";
            document.getElementById('btn-sell').className = s === 'sell' ? "flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase bg-red-600 text-white shadow-lg" : "flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase text-slate-500";
        }

        function showNotification(msg, type) {
            const c = document.getElementById('notification-container') || createNotifContainer();
            const el = document.createElement('div');
            el.className = `p-4 rounded-xl shadow-2xl mb-3 text-sm font-bold text-white transform transition-all translate-x-full ${type==='error'?'bg-red-600':type==='success'?'bg-green-600':type==='warning'?'bg-yellow-600':'bg-blue-600'}`;
            el.innerHTML = `<div class="flex items-center gap-3"><i data-lucide="${type==='error'?'alert-circle':type==='warning'?'alert-triangle':'check-circle'}" class="w-5 h-5"></i><span>${msg}</span></div>`;
            c.appendChild(el);
            lucide.createIcons();
            requestAnimationFrame(() => el.classList.remove('translate-x-full'));
            setTimeout(() => { el.classList.add('translate-x-full', 'opacity-0'); setTimeout(()=>el.remove(), 300); }, 4000);
        }

        function createNotifContainer() {
            const d = document.createElement('div');
            d.id = 'notification-container';
            d.className = 'fixed top-4 right-4 z-[300] flex flex-col items-end w-full max-w-sm pointer-events-none';
            document.body.appendChild(d);
            return d;
        }

        async function confirmCloseTrade() {
            if (!currentEditTradeId) return;
            const closePrice = parseFloat(document.getElementById('e-closePrice').value);
            const user = auth.currentUser;
            const t = trades.find(tr => tr.id === currentEditTradeId);
            if (!t) return;
            
            let pnl = 0;
            const multiplier = t.instrument.includes('Vol') ? 1 : 10; 
            if (t.type === 'buy') pnl = (closePrice - t.entryPrice) * t.lots * multiplier;
            else pnl = (t.entryPrice - closePrice) * t.lots * multiplier;

            await db.collection('users').doc(user.uid).collection('trades').doc(currentEditTradeId).update({
                status: 'closed',
                closePrice: closePrice,
                closeTime: firebase.firestore.FieldValue.serverTimestamp(),
                pnl: pnl
            });
            closeEditModal();
            showNotification('Trade closed', 'success');
        }

        async function deleteTrade() {
            if (!currentEditTradeId || !confirm('Delete this trade record?')) return;
            await db.collection('users').doc(auth.currentUser.uid).collection('trades').doc(currentEditTradeId).delete();
            closeEditModal();
            showNotification('Trade deleted', 'success');
        }
        
        function exportCSV() {
            const closed = trades.filter(t => t.status === 'closed');
            let csv = 'Time,Instrument,Type,Lots,Entry,Exit,PnL\n';
            closed.forEach(t => {
                csv += `${new Date(t.openTime.seconds*1000).toISOString()},${t.instrument},${t.type},${t.lots},${t.entryPrice},${t.closePrice},${t.pnl}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trading_journal.csv';
            a.click();
        }
        
        // Placeholder for missing load functions
        function loadLeaderboard() {
            document.getElementById('leaderboardContent').innerHTML = '<p class="text-center text-slate-500 text-xs">Leaderboard coming soon.</p>';
        }
        function loadFeedback() {
             const user = auth.currentUser;
             if(!user) return;
             db.collection('users').doc(user.uid).collection('comments').orderBy('createdAt', 'desc').onSnapshot(snap => {
                 const div = document.getElementById('feedbackContent');
                 if(snap.empty) {
                     div.innerHTML = '<p class="text-center text-slate-500 text-xs">No feedback from mentors yet.</p>';
                 } else {
                     div.innerHTML = snap.docs.map(d => {
                         const c = d.data();
                         return `<div class="bg-slate-900/50 p-4 rounded-xl border border-slate-800"><p class="text-sm text-slate-200">${c.text}</p><p class="text-[10px] text-slate-500 mt-2 text-right">MENTOR • ${c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleDateString() : ''}</p></div>`;
                     }).join('');
                 }
             });
        }
    </script>
    <!-- =========================================================
 SKILLFORGE LIVE TRADING EXTENSIONS (SAFE PATCH)
 DO NOT MOVE – DO NOT EDIT EXISTING CODE
========================================================= -->
<script>
/* ===========================
   GLOBAL STATE EXTENSIONS
=========================== */
let ACCOUNT_BALANCE = 10000;
let RISK_PERCENT = 1;
let dailyStartBalance = ACCOUNT_BALANCE;
const MAX_DAILY_LOSS_PCT = 3;
let equityHistory = [];
let liveCandles = {};
let priceMap = {};
let currentSession = 'Asia';

/* ===========================
   SESSION TRACKING
=========================== */
function getTradingSession() {
    const h = new Date().getUTCHours();
    if (h >= 7 && h < 16) return 'London';
    if (h >= 13 && h < 22) return 'New York';
    return 'Asia';
}

/* ===========================
   RISK & LOT CALCULATION
=========================== */
function calculateRiskLot(entry, stop) {
    const riskAmount = ACCOUNT_BALANCE * (RISK_PERCENT / 100);
    const distance = Math.abs(entry - stop);
    if (!distance) return 0;
    return Number((riskAmount / (distance * 10)).toFixed(2));
}

/* ===========================
   DAILY LOSS LOCKOUT
=========================== */
function checkDailyLoss() {
    const lossPct = ((ACCOUNT_BALANCE - dailyStartBalance) / dailyStartBalance) * 100;
    if (lossPct <= -MAX_DAILY_LOSS_PCT) {
        const btn = document.getElementById('btn-new-trade');
        if (btn) btn.disabled = true;
        showNotification('Max daily loss reached. Trading locked.', 'error');
    }
}

/* ===========================
   LIVE PIP & PNL CALC
=========================== */
function getPipSize(symbol) {
    if (symbol.includes('JPY')) return 0.01;
    if (symbol.includes('XAU')) return 0.1;
    if (symbol.includes('BTC')) return 1;
    return 0.0001;
}

function updateLiveTrades(symbol, price) {
    trades.forEach(t => {
        if (t.status !== 'open' || t.instrument !== symbol) return;

        const pip = getPipSize(symbol);
        const dir = t.type === 'buy' ? 1 : -1;
        const pips = ((price - t.entryPrice) * dir) / pip;
        const pnl = pips * t.lots * 10;

        t.livePrice = price;
        t.pips = Number(pips.toFixed(1));
        t.pnl = Number(pnl.toFixed(2));
    });

    renderActiveTrades();
    updateStats();
}

/* ===========================
   REAL CANDLES FROM TICKS
=========================== */
const CANDLE_INTERVAL = 60;

function updateCandle(symbol, price, epoch) {
    if (!chart || symbol !== currentChartSymbol) return;

    const t = epoch - (epoch % CANDLE_INTERVAL);
    if (!liveCandles[symbol]) {
        liveCandles[symbol] = { time: t, open: price, high: price, low: price, close: price };
        candleSeries.setData([liveCandles[symbol]]);
        return;
    }

    const c = liveCandles[symbol];
    if (t > c.time) {
        c.time = t;
        c.open = c.close;
        c.high = c.close;
        c.low = c.close;
    }

    c.high = Math.max(c.high, price);
    c.low = Math.min(c.low, price);
    c.close = price;

    candleSeries.update(c);
}

/* ===========================
   DERIV WS EXTENSION
=========================== */
const _oldUpdatePrice = updatePrice;
updatePrice = function (tick) {
    _oldUpdatePrice(tick);
    priceMap[tick.symbol] = tick.quote;
    updateLiveTrades(tick.symbol, tick.quote);
    updateCandle(tick.symbol, tick.quote, tick.epoch);
};

/* ===========================
   EQUITY & EXPECTANCY
=========================== */
function updateEquity(pnl) {
    ACCOUNT_BALANCE += pnl;
    equityHistory.push({ time: Date.now() / 1000, value: ACCOUNT_BALANCE });
    checkDailyLoss();
}

function calculateExpectancy() {
    const closed = trades.filter(t => t.status === 'closed');
    if (!closed.length) return 0;

    const wins = closed.filter(t => t.pnl > 0);
    const losses = closed.filter(t => t.pnl < 0);

    const winRate = wins.length / closed.length;
    const avgWin = wins.reduce((a, t) => a + t.pnl, 0) / (wins.length || 1);
    const avgLoss = Math.abs(losses.reduce((a, t) => a + t.pnl, 0) / (losses.length || 1));

    return (winRate * avgWin) - ((1 - winRate) * avgLoss);
}

/* ===========================
   TRADE CLOSE HOOK
=========================== */
const _oldConfirmCloseTrade = confirmCloseTrade;
confirmCloseTrade = async function () {
    const t = trades.find(tr => tr.id === currentEditTradeId);
    await _oldConfirmCloseTrade();
    if (t && t.pnl) updateEquity(t.pnl);
};
</script>

</body>
</html>
