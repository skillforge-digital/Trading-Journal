<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skillforge Trading Journal</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <meta name="deriv-token" content="VRTC4389111">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
    body{font-family:'Plus Jakarta Sans',sans-serif;background:#0f172a;color:#e2e8f0}
    .glass{background:rgba(2,6,23,.7);backdrop-filter:blur(12px);border:1px solid rgba(148,163,184,.15)}
    .profit-text{color:#34d399}
    .loss-text{color:#f87171}
    .section{display:none}
    .section.active{display:block}
    .custom-scrollbar{scrollbar-width:thin;scrollbar-color:#334155 transparent}
    .custom-scrollbar::-webkit-scrollbar{width:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#334155;border-radius:9999px}
    .hidden { display: none !important; }
  </style>
</head>
<body class="pb-20">

  <!-- AUTH CONTAINER -->
  <div id="authContainer" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-950/95 backdrop-blur-xl hidden" role="dialog" aria-modal="true">
    <div class="glass w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl flex flex-col relative border border-slate-700 max-h-[90vh] overflow-y-auto">
      <div class="p-8 pb-0 text-center">
        <div class="flex items-center justify-center mb-5"><img src="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg" alt="Skillforge Digital" class="w-20 h-20 object-contain rounded-xl shadow-2xl ring-1 ring-white/10"></div>
        <h1 class="text-2xl md:text-3xl font-black tracking-tight mb-1">SKILLFORGE <span class="text-blue-500">DIGITAL</span> &amp; CO. LTD</h1>
        <p class="text-blue-400 text-xs font-bold uppercase tracking-[0.2em]">Official Company</p>
      </div>
      
      <!-- Landing Options -->
      <div id="landing-options" class="p-8 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <button id="btn-show-login" type="button" class="group p-6 bg-slate-900/50 border border-slate-800 rounded-2xl hover:bg-blue-600 hover:border-blue-500 transition-all text-left">
            <div class="bg-slate-800 group-hover:bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors"><i data-lucide="user" class="text-slate-400 group-hover:text-white w-5 h-5"></i></div>
            <h3 class="font-bold text-white text-sm">Student Login</h3>
            <p class="text-[10px] text-slate-500 group-hover:text-blue-200 mt-1">Access your journal</p>
          </button>
          <button id="btn-show-register" type="button" class="group p-6 bg-slate-900/50 border border-slate-800 rounded-2xl hover:bg-blue-600 hover:border-blue-500 transition-all text-left">
            <div class="bg-slate-800 group-hover:bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors"><i data-lucide="user-plus" class="text-slate-400 group-hover:text-white w-5 h-5"></i></div>
            <h3 class="font-bold text-white text-sm">New Student</h3>
            <p class="text-[10px] text-slate-500 group-hover:text-blue-200 mt-1">Create account</p>
          </button>
        </div>
        <div class="relative py-4"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div><div class="relative flex justify-center"><span class="bg-slate-900 px-2 text-[10px] text-slate-500 uppercase font-bold">Authorized Personnel</span></div></div>
        <button id="btn-show-admin" type="button" class="w-full p-4 rounded-xl border border-slate-800 hover:bg-slate-800 transition-all flex items-center justify-center gap-2 group">
          <i data-lucide="shield-check" class="text-slate-500 group-hover:text-red-500 w-4 h-4"></i>
          <span class="text-xs font-bold text-slate-400 group-hover:text-white uppercase tracking-wider">Mentor Access</span>
        </button>
      </div>

      <!-- Auth Forms -->
      <div id="auth-forms" class="p-8 hidden">
        <div class="flex items-center gap-4 mb-6">
            <button id="btn-back-auth" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white" type="button"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 id="auth-title" class="text-xl font-bold text-white"></h2>
        </div>
        <form id="authForm" class="space-y-4 hidden" novalidate>
          <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Email Address</label><input type="email" id="email" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none"></div>
          <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Password</label><input type="password" id="password" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none"></div>
          <button type="submit" id="btn-auth-action" class="w-full py-3 rounded-xl bg-blue-600 text-white font-bold text-sm uppercase tracking-wider shadow-lg mt-2">Proceed</button>
          <button type="button" id="forgotPasswordLink" class="w-full mt-2 text-[11px] font-bold uppercase tracking-widest text-blue-400 hover:text-blue-300">Forgot password?</button>
        </form>
        <form id="adminForm" class="space-y-4 hidden" novalidate>
          <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Security Passcode</label><input type="password" id="adminPasscode" placeholder="••••••••" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center"></div>
          <button type="submit" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-sm uppercase tracking-wider">Verify Identity</button>
        </form>
      </div>
    </div>
  </div>

  <!-- MAIN APP CONTENT -->
  <div id="appContent" class="hidden">
    
    <!-- Header -->
    <header class="glass sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg" alt="Skillforge Digital" class="w-10 h-10 rounded-xl object-contain shadow-2xl ring-1 ring-white/10">
            <div class="text-xl font-extrabold tracking-tight text-white hidden md:block">SKILLFORGE <span class="text-blue-500">DIGITAL</span> &amp; CO. LTD</div>
        </div>
        <div class="flex items-center gap-2">
          <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 text-xs"><div class="w-2 h-2 rounded-full bg-red-500"></div><span class="text-slate-400 font-medium hidden sm:inline">LIVE DATA</span></div>
          <button id="btn-toggle-chart" type="button" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white" title="Toggle Chart"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
          <button id="btn-new-trade" type="button" class="hidden sm:flex px-4 py-2 rounded-lg text-sm font-bold items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white"><i data-lucide="plus-circle" class="w-4 h-4"></i> NEW TRADE</button>
          <button id="btn-export-csv" type="button" class="hidden sm:flex px-4 py-2 rounded-lg text-sm font-bold items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300"><i data-lucide="download" class="w-4 h-4"></i> EXPORT CSV</button>
          
          <!-- Nav Tabs (Admin Hidden by Default) -->
          <nav class="flex gap-1 ml-2">
            <button data-tab="journal" class="p-2 rounded-lg bg-slate-800 text-white"><i data-lucide="home" class="w-5 h-5"></i></button>
            <button data-tab="admin" class="hidden p-2 rounded-lg bg-red-900/20 text-red-400 hover:bg-red-900/40"><i data-lucide="shield" class="w-5 h-5"></i></button>
          </nav>
          
          <button id="btn-logout" type="button" class="p-2 rounded-lg bg-red-900/20 hover:bg-red-900/40 text-red-400 ml-2"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
      </div>
      
      <!-- Ticker Tape -->
      <div class="max-w-7xl mx-auto px-4 pb-4">
        <div class="mt-2 flex items-center gap-3">
          <div class="relative w-full max-w-xs">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500"></i>
            <input type="text" id="marketSearch" placeholder="Search Assets..." class="w-full bg-slate-950 border border-slate-800 rounded-full py-1.5 pl-9 pr-4 text-xs text-white focus:outline-none focus:border-blue-500">
          </div>
          <div id="tickerContainer" class="flex gap-3 overflow-x-auto custom-scrollbar flex-1 py-1"></div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 mt-8 space-y-8">
      
      <!-- Chart Section (Hidden Default) -->
      <section id="chartSection" class="hidden mb-8">
        <div class="glass rounded-2xl overflow-hidden border border-slate-700">
          <div class="p-3 bg-slate-900/50 flex justify-between items-center border-b border-slate-800">
            <div class="flex items-center gap-4">
              <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Market Analysis</span>
              <span id="chartSymbolName" class="text-sm font-black text-blue-400">LOADING...</span>
            </div>
            <button id="btn-close-chart" type="button" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
          </div>
          <div id="tv-container" class="h-[400px] w-full bg-slate-950 relative"></div>
        </div>
      </section>

      <!-- STUDENT DASHBOARD -->
      <section id="journal" class="section active space-y-6">
        
        <!-- Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" aria-label="Overview metrics">
            <div class="glass p-5 rounded-2xl border-l-4 border-blue-500"><p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Realized PnL</p><h2 id="totalPnl" class="text-2xl font-black font-mono mt-1">$0.00</h2></div>
            <div class="glass p-5 rounded-2xl border-l-4 border-green-500"><p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Win Rate</p><h2 id="winRate" class="text-2xl font-black font-mono mt-1">0%</h2></div>
            <div class="glass p-5 rounded-2xl border-l-4 border-purple-500"><p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Total Lots</p><h2 id="totalLots" class="text-2xl font-black font-mono mt-1">0.00</h2></div>
            <div class="glass p-5 rounded-2xl border-l-4 border-slate-500"><p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Active Trades</p><h2 id="activeCount" class="text-2xl font-black font-mono mt-1">0</h2></div>
        </div>

        <!-- Live Market & Equity -->
        <div class="grid md:grid-cols-2 gap-6">
            <div class="glass p-6 rounded-2xl space-y-4">
                <div class="flex items-center justify-between"><div class="flex items-center gap-2"><i data-lucide="activity" class="text-blue-500 w-5 h-5"></i><h3 class="text-sm font-bold text-white uppercase tracking-wider">Live Market</h3></div><div class="flex items-center gap-2"><select id="liveSymbolSelect" class="bg-slate-950 border border-slate-800 rounded-xl p-2 text-white text-xs outline-none min-w-40"></select><span id="liveChartStatus" class="text-[10px] font-bold uppercase text-slate-500">Disconnected</span></div></div>
                <canvas id="liveChartCanvas" height="160" class="w-full rounded-xl bg-slate-950 border border-slate-800"></canvas>
            </div>
            <div class="glass rounded-2xl overflow-hidden">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center"><span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Equity Curve</span></div>
                <canvas id="equityCurveCanvas" height="220" class="w-full bg-slate-950"></canvas>
            </div>
        </div>

        <!-- Tab Controls -->
        <div class="flex flex-wrap gap-2 mb-6 bg-slate-900/50 p-1.5 rounded-2xl w-fit border border-slate-800" role="tablist">
          <button onclick="window.switchJournalTab('active')" id="tab-active" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-blue-400">Active</button>
          <button onclick="window.switchJournalTab('history')" id="tab-history" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Closed</button>
          <button onclick="window.switchJournalTab('leaderboard')" id="tab-leaderboard" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Leaderboard</button>
          <button onclick="window.switchJournalTab('feedback')" id="tab-feedback" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Feedback</button>
        </div>

        <!-- Tab Contents -->
        <div id="activeTradesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        
        <div id="historyList" class="hidden glass rounded-2xl border border-slate-800 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-900/80 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-800">
                    <tr><th class="p-5">Instrument</th><th class="p-5">Side</th><th class="p-5">Lots</th><th class="p-5">Entry / Close</th><th class="p-5">Pips</th><th class="p-5 text-right">PnL</th><th class="p-5 text-right">Date</th></tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-800/50"></tbody>
                </table>
            </div>
        </div>
        
        <div id="leaderboardList" class="hidden">
          <div class="glass rounded-2xl overflow-hidden border border-slate-800 max-w-2xl mx-auto">
            <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3"><i data-lucide="trophy" class="text-yellow-500 w-5 h-5"></i><h3 class="text-sm font-bold text-white uppercase tracking-wider">Top Traders</h3></div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <tbody id="leaderboardContent"></tbody>
                </table>
            </div>
          </div>
        </div>
        
        <div id="feedbackList" class="hidden">
          <div class="glass rounded-2xl overflow-hidden border border-slate-800 max-w-2xl mx-auto">
            <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3"><i data-lucide="message-circle" class="text-blue-500 w-5 h-5"></i><h3 class="text-sm font-bold text-white uppercase tracking-wider">Instructor Feedback</h3></div>
            <div id="feedbackContent" class="p-5 space-y-4"><p class="text-slate-500 text-sm text-center">Loading feedback...</p></div>
          </div>
        </div>
        
        <!-- User & Trade Logging (Always Visible at bottom) -->
        <div class="grid md:grid-cols-2 gap-6 mt-8">
          <div class="glass p-6 rounded-2xl space-y-4">
            <div class="flex items-center gap-2"><i data-lucide="user" class="text-slate-400 w-5 h-5"></i><h3 class="text-sm font-bold text-white uppercase tracking-wider">User Profile</h3></div>
            <div class="flex items-center justify-between"><p id="currentUserEmail" class="text-xs text-slate-300 font-bold truncate"></p></div>
            <p id="currentUserId" class="text-[10px] text-slate-500 font-mono"></p>
          </div>
          <div class="glass p-6 rounded-2xl space-y-4">
            <div class="flex items-center gap-2"><i data-lucide="file-plus" class="text-slate-400 w-5 h-5"></i><h3 class="text-sm font-bold text-white uppercase tracking-wider">Log Trade</h3></div>
            <div class="grid grid-cols-2 gap-3">
              <input id="tradeInstrument" type="text" placeholder="Instrument" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none">
              <select id="tradeType" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none"><option value="buy">Buy</option><option value="sell">Sell</option></select>
              <input id="tradeLots" type="number" step="0.01" placeholder="Lots" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none">
              <input id="tradePnl" type="number" step="0.01" placeholder="PnL" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none">
              <select id="tradeStatus" class="bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none"><option value="open">Open</option><option value="closed">Closed</option></select>
              <button id="addTrade" class="py-2.5 rounded-xl bg-green-600 hover:bg-green-500 text-white text-[11px] font-black uppercase tracking-widest">Add</button>
            </div>
          </div>
        </div>

      </section>

      <!-- ADMIN PANEL (Consolidated) -->
      <section id="admin" class="section grid grid-cols-1 md:grid-cols-4 gap-6">
        
        <!-- Sidebar -->
        <aside class="glass rounded-2xl overflow-hidden h-[70vh] flex flex-col">
            <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-white uppercase">Students</h3>
                <button id="refreshStudents" class="text-slate-400 hover:text-white"><i data-lucide="refresh-ccw" class="w-4 h-4"></i></button>
            </div>
            <div id="studentList" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                <p class="text-center text-slate-500 text-xs mt-4">Loading students...</p>
            </div>
            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <button id="publishLeaderboard" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-bold uppercase tracking-wider">Publish Leaderboard</button>
            </div>
        </aside>

        <!-- Main Content -->
        <section class="md:col-span-3 space-y-6">
            <!-- Student Header -->
            <div id="studentHeader" class="glass p-6 rounded-2xl border-l-4 border-blue-500 hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="studentEmail" class="text-2xl font-bold text-white">Select a Student</h2>
                        <p class="text-slate-500 text-xs uppercase tracking-widest mt-1">Student ID: <span id="studentId">---</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Total Profit</p>
                        <h3 id="adminTotalPnl" class="text-2xl font-black font-mono text-white">$0.00</h3>
                    </div>
                </div>
            </div>
            
            <!-- Trades List -->
            <div id="adminTradesContainer" class="glass rounded-2xl overflow-hidden border border-slate-800 hidden">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50"><h3 class="text-sm font-bold text-white uppercase">Student Trades</h3></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900/80 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-800">
                            <tr><th class="p-5">Time</th><th class="p-5">Instrument</th><th class="p-5">Side</th><th class="p-5">Lots</th><th class="p-5">PnL</th><th class="p-5">Status</th></tr>
                        </thead>
                        <tbody id="adminTradeTable" class="divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
            </div>

            <!-- Feedback -->
            <div id="feedbackSection" class="glass rounded-2xl overflow-hidden border border-slate-800 hidden">
                <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3"><i data-lucide="message-circle" class="text-blue-500 w-5 h-5"></i><h3 class="text-sm font-bold text-white uppercase tracking-wider">Instructor Feedback</h3></div>
                <div class="p-6 space-y-4">
                    <div id="commentsList" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar"></div>
                    <form id="commentForm" class="flex gap-2">
                        <input id="commentInput" type="text" placeholder="Write feedback..." class="flex-1 bg-slate-950 border border-slate-800 rounded-xl p-3 text-white text-sm outline-none focus:border-blue-500">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </form>
                </div>
            </div>
        </section>
      </section>

    </main>
  </div>

  <!-- FIREBASE MODULES -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, addDoc, getDocs, getDoc, query, orderBy, onSnapshot, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
    
    // --- FIREBASE CONFIG ---
    const firebaseConfig = { apiKey:"AIzaSyA28jc1OxMfc33m7rk8fCrfgmnw_uLzc50", authDomain:"trading-journal-914c4.firebaseapp.com", projectId:"trading-journal-914c4", storageBucket:"trading-journal-914c4.firebasestorage.app", messagingSenderId:"504948935584", appId:"1:504948935584:web:dbf3c74177c07941785f7c", measurementId:"G-1234567890" };
    
    // --- CONSTANTS ---
    const DERIV_APP_ID = 123621;
    const ADMIN_PASSCODE = '#skillmindset#';
    
    // --- INIT ---
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- VARIABLES ---
    let currentUserDocId = null;
    let selectedStudentId = null;
    let ws = null; // Main Deriv WS (Account)
    let mktWs = null; // Ticker WS
    let sparkWs = null; // Mini Chart WS
    let chartWs = null; // MAIN CHART WS
    let authMode = null;
    let isAdminVerified = false;
    let hasAdminClaim = false;
    let marketData = [];
    let myTrades = [];
    let journalTab = 'active';
    let livePrices = [];
    let derivActive = new Map();
    let chartInstance = null;
    let candleSeries = null;
    let currentChartSymbol = '';
    let trailingSettings = {};

    // --- UTILS ---
    function notify(msg, type='info'){
        const div = document.createElement('div');
        div.className = `fixed top-4 right-4 z-[300] px-6 py-3 rounded-xl shadow-2xl font-bold text-xs uppercase tracking-wider animate-bounce ${type==='error'?'bg-red-600 text-white':'bg-slate-800 text-white border border-slate-700'}`;
        div.innerText = msg;
        document.body.appendChild(div);
        setTimeout(()=>div.remove(), 3000);
    }

    function setTab(tabName) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(tabName);
        if(target) target.classList.add('active');
        
        // Update Nav State
        document.querySelectorAll('nav button').forEach(btn => {
            if(btn.dataset.tab === tabName) btn.classList.add('bg-blue-600', 'text-white');
            else {
                btn.classList.remove('bg-blue-600', 'text-white');
                if(btn.dataset.tab === 'admin') btn.classList.add('text-red-400');
                else btn.classList.add('text-white');
            }
        });
    }

    // --- EVENT LISTENERS ---
    window.addEventListener('DOMContentLoaded', () => {
      if(window.lucide) window.lucide.createIcons();
      initActiveSymbols();

      // Auth UI Toggles
      const showAuthForm = (mode) => {
        authMode = mode;
        document.getElementById('landing-options').classList.add('hidden');
        document.getElementById('auth-forms').classList.remove('hidden');
        document.getElementById('authForm').classList.toggle('hidden', mode==='admin');
        document.getElementById('adminForm').classList.toggle('hidden', mode!=='admin');
        document.getElementById('auth-title').innerText = mode==='login'?'Student Login':mode==='register'?'New Student':'Mentor Access';
        const forgotBtn = document.getElementById('forgotPasswordLink');
        if(forgotBtn) forgotBtn.classList.toggle('hidden', mode!=='login');
      };

      document.getElementById('btn-show-login').onclick = () => showAuthForm('login');
      document.getElementById('btn-show-register').onclick = () => showAuthForm('register');
      document.getElementById('btn-show-admin').onclick = () => showAuthForm('admin');
      document.getElementById('btn-back-auth').onclick = () => {
        document.getElementById('landing-options').classList.remove('hidden');
        document.getElementById('auth-forms').classList.add('hidden');
      };

      // Auth Actions
      document.getElementById('authForm').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        try {
          if(authMode === 'login') {
            await signInWithEmailAndPassword(auth, email, password);
          } else if(authMode === 'register') {
            const res = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, 'users', res.user.uid), { email, createdAt: serverTimestamp() }, { merge: true });
          }
        } catch(err) { notify(err.message, 'error'); }
      };

      document.getElementById('adminForm').onsubmit = async (e) => {
        e.preventDefault();
        const pass = document.getElementById('adminPasscode').value.trim();
        if(pass === ADMIN_PASSCODE) {
          isAdminVerified = true;
          const u = auth.currentUser;
          if(u) {
             await setDoc(doc(db, 'users', u.uid), { role: 'mentor' }, { merge: true });
             hasAdminClaim = true;
          }
          updateAdminNavVisibility();
          document.getElementById('authContainer').classList.add('hidden');
          setTab('admin');
          loadStudents();
          notify('Mentor access granted', 'success');
        } else {
          notify('Invalid mentor passcode', 'error');
        }
      };
      
      document.getElementById('signOutBtn').onclick = async () => {
          await signOut(auth);
          isAdminVerified = false;
          window.location.reload();
      };
      
      document.getElementById('btn-logout').onclick = async () => {
          await signOut(auth);
          isAdminVerified = false;
          window.location.reload();
      };

      // Nav
      document.querySelectorAll('nav button').forEach(btn => {
          btn.onclick = () => setTab(btn.dataset.tab);
      });

      // Features
      document.getElementById('addTrade').onclick = addTrade;
      document.getElementById('btn-toggle-chart').onclick = toggleChart;
      document.getElementById('btn-close-chart').onclick = toggleChart;
      document.getElementById('btn-export-csv').onclick = exportCSV;
      
      document.getElementById('refreshStudents').onclick = loadStudents;
      document.getElementById('publishLeaderboard').onclick = publishLeaderboard;

      // Auth State Observer
      onAuthStateChanged(auth, user => {
        if(user) {
          currentUserDocId = user.uid;
          document.getElementById('authContainer').classList.add('hidden');
          document.getElementById('appContent').classList.remove('hidden');
          document.getElementById('currentUserEmail').innerText = user.email;
          document.getElementById('currentUserId').innerText = `ID: ${user.uid.slice(0,6)}`;
          
          // Check Admin
          getDoc(doc(db, 'users', user.uid)).then(snap => {
              if(snap.exists() && snap.data().role === 'mentor') {
                  hasAdminClaim = true;
                  updateAdminNavVisibility();
              }
          });

          // Load Data
          loadMyTrades();
          loadJournalLeaderboard();
          loadJournalFeedback();

          // Realtime Trades
          onSnapshot(query(collection(db, 'users', user.uid, 'trades'), orderBy('openTime', 'desc')), snap => {
             myTrades = snap.docs.map(d => ({id: d.id, ...d.data()}));
             if(journalTab === 'active') renderActiveTrades();
             if(journalTab === 'history') renderClosedHistory();
             drawEquityCurve(myTrades.filter(t => t.status === 'closed'));
             
             // Update Metrics
             const closed = myTrades.filter(t => t.status === 'closed');
             const totalPnl = closed.reduce((a,t) => a + (t.pnl||0), 0);
             const wins = closed.filter(t => (t.pnl||0) > 0).length;
             const winRate = closed.length > 0 ? ((wins / closed.length) * 100).toFixed(0) : 0;
             const activeCount = myTrades.filter(t => t.status === 'open' || t.status === 'running').length;
             
             document.getElementById('totalPnl').innerText = `$${totalPnl.toFixed(2)}`;
             document.getElementById('totalPnl').className = `text-2xl font-black font-mono mt-1 ${totalPnl>=0?'profit-text':'loss-text'}`;
             document.getElementById('winRate').innerText = `${winRate}%`;
             document.getElementById('activeCount').innerText = activeCount;
          });

        } else {
          document.getElementById('authContainer').classList.remove('hidden');
          document.getElementById('appContent').classList.add('hidden');
        }
      });
    });

    function updateAdminNavVisibility() {
        const btn = document.querySelector('nav button[data-tab="admin"]');
        if(btn) btn.classList.toggle('hidden', !(isAdminVerified || hasAdminClaim));
    }

    // --- ADMIN LOGIC ---
    function loadStudents() {
        const list = document.getElementById('studentList');
        list.innerHTML = '<p class="text-center text-slate-500 text-xs mt-4">Loading...</p>';
        getDocs(collection(db, 'users')).then(snap => {
            if(snap.empty) { list.innerHTML = '<p class="text-center text-slate-500 text-xs mt-4">No students found.</p>'; return; }
            list.innerHTML = snap.docs.map(docItem => {
                const data = docItem.data();
                const email = data.email || 'Unknown';
                const color = 'bg-blue-600'; 
                return `
                <div onclick="window.selectStudent('${docItem.id}', '${email}')" class="p-3 rounded-lg hover:bg-slate-800 cursor-pointer transition-colors border border-transparent hover:border-slate-700 group flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-xs font-bold text-white shadow-lg shrink-0">${email.substring(0,2).toUpperCase()}</div>
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-slate-300 truncate group-hover:text-white transition-colors">${email}</p>
                        <p class="text-[10px] text-slate-500 truncate font-mono">ID: ${docItem.id.slice(0,6)}</p>
                    </div>
                </div>`;
            }).join('');
        });
    }

    window.selectStudent = function(uid, email) {
        selectedStudentId = uid;
        // Show sections
        document.getElementById('studentHeader').classList.remove('hidden');
        document.getElementById('adminTradesContainer').classList.remove('hidden');
        document.getElementById('feedbackSection').classList.remove('hidden');
        
        // Update Info
        document.getElementById('studentEmail').innerText = email;
        document.getElementById('studentId').innerText = uid;
        
        // Load Data
        loadStudentTrades(uid);
        loadStudentComments(uid);
    };

    function loadStudentTrades(uid) {
        onSnapshot(query(collection(db, 'users', uid, 'trades'), orderBy('openTime', 'desc')), snap => {
            const trades = snap.docs.map(d => d.data());
            const totalPnl = trades.reduce((a,t) => a + (t.status==='closed'?(t.pnl||0):0), 0);
            
            const pnlEl = document.getElementById('adminTotalPnl');
            pnlEl.innerText = `$${totalPnl.toFixed(2)}`;
            pnlEl.className = `text-2xl font-black font-mono text-white ${totalPnl>=0?'profit-text':'loss-text'}`;
            
            const tbody = document.getElementById('adminTradeTable');
            if(trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500 text-sm">No trades found.</td></tr>';
            } else {
                tbody.innerHTML = trades.map(t => `
                    <tr class="hover:bg-slate-800/30 border-b border-slate-800/50">
                        <td class="p-4 text-xs text-slate-400">${t.openTime && t.openTime.seconds ? new Date(t.openTime.seconds*1000).toLocaleDateString() : '-'}</td>
                        <td class="p-4 text-xs font-bold text-white">${t.instrument}</td>
                        <td class="p-4"><span class="px-2 py-0.5 rounded text-[9px] font-black uppercase ${t.type==='buy'?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400'}">${t.type}</span></td>
                        <td class="p-4 text-xs font-mono text-slate-400">${t.lots||0}</td>
                        <td class="p-4 text-xs font-mono font-bold ${t.pnl>=0?'profit-text':'loss-text'}">$${(t.pnl||0).toFixed(2)}</td>
                        <td class="p-4 text-[10px] uppercase font-bold text-slate-500">${t.status}</td>
                    </tr>
                `).join('');
            }
        });
    }

    function loadStudentComments(uid) {
        const list = document.getElementById('commentsList');
        onSnapshot(query(collection(db, 'users', uid, 'comments'), orderBy('createdAt', 'desc')), snap => {
            if(snap.empty) { list.innerHTML = '<p class="text-xs text-slate-500 italic">No feedback yet.</p>'; return; }
            list.innerHTML = snap.docs.map(docItem => {
                const c = docItem.data();
                return `
                <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                    <p class="text-xs text-slate-300">${c.text}</p>
                    <p class="text-[9px] text-slate-600 mt-1 text-right">${c.createdAt && c.createdAt.seconds ? new Date(c.createdAt.seconds*1000).toLocaleString() : ''}</p>
                </div>`;
            }).join('');
        });

        // Setup Form
        const form = document.getElementById('commentForm');
        form.onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if(!text || !selectedStudentId) return;
            
            await addDoc(collection(db, 'users', selectedStudentId, 'comments'), {
                text, createdAt: serverTimestamp(), author: 'Admin'
            });
            input.value = '';
            notify('Feedback sent', 'success');
        };
    }

    // --- STUDENT LOGIC ---
    function addTrade() {
        if(!currentUserDocId) { notify('Login first', 'error'); return; }
        const instrument = document.getElementById('tradeInstrument').value.trim();
        const type = document.getElementById('tradeType').value;
        const lots = parseFloat(document.getElementById('tradeLots').value || '0');
        const pnl = parseFloat(document.getElementById('tradePnl').value || '0');
        const status = document.getElementById('tradeStatus').value;
        
        if(!instrument) { notify('Enter instrument', 'error'); return; }
        
        addDoc(collection(db, 'users', currentUserDocId, 'trades'), {
            instrument, type, lots, pnl, status, openTime: serverTimestamp()
        }).then(() => {
            document.getElementById('tradeInstrument').value = '';
            document.getElementById('tradeLots').value = '';
            document.getElementById('tradePnl').value = '';
            notify('Trade added', 'success');
        }).catch(e => notify(e.message, 'error'));
    }

    function loadMyTrades() {
        if(!currentUserDocId) return;
        // This is handled by the onSnapshot in onAuthStateChanged
    }

    // --- LEADERBOARD LOGIC ---
    async function publishLeaderboard() {
        if(!isAdminVerified && !hasAdminClaim) { notify('Admin only', 'error'); return; }
        
        const usersSnap = await getDocs(collection(db, 'users'));
        const entries = [];
        
        for(const uDoc of usersSnap.docs) {
            const uid = uDoc.id;
            const email = uDoc.data().email || 'Unknown';
            const tradesSnap = await getDocs(collection(db, 'users', uid, 'trades'));
            let total = 0;
            tradesSnap.forEach(t => {
                if(t.data().status === 'closed') total += (t.data().pnl || 0);
            });
            entries.push({ uid, email, totalPnl: total });
        }
        
        entries.sort((a,b) => b.totalPnl - a.totalPnl);
        
        await setDoc(doc(db, 'leaderboard', 'current'), { entries, publishedAt: serverTimestamp() }, { merge: true });
        notify('Leaderboard published!', 'success');
        loadJournalLeaderboard(); // refresh local view
    }

    async function loadJournalLeaderboard() {
        const tbody = document.getElementById('leaderboardContent');
        const snap = await getDoc(doc(db, 'leaderboard', 'current'));
        
        if(snap.exists() && snap.data().entries) {
            const entries = snap.data().entries;
            if(entries.length === 0) { tbody.innerHTML = '<tr><td class="p-4 text-center text-slate-500 text-xs">No entries.</td></tr>'; return; }
            
            tbody.innerHTML = entries.map((e, i) => `
                <tr class="hover:bg-slate-800/30 border-b border-slate-800/50">
                    <td class="p-4 text-xs font-mono text-slate-400">${i+1}</td>
                    <td class="p-4 text-xs font-bold text-white">${e.email}</td>
                    <td class="p-4 text-xs font-mono font-bold ${e.totalPnl>=0?'profit-text':'loss-text'}">$${e.totalPnl.toFixed(2)}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td class="p-4 text-center text-slate-500 text-xs">Leaderboard not published yet.</td></tr>';
        }
    }

    function loadJournalFeedback() {
        if(!currentUserDocId) return;
        const container = document.getElementById('feedbackContent');
        onSnapshot(query(collection(db, 'users', currentUserDocId, 'comments'), orderBy('createdAt', 'desc')), snap => {
            if(snap.empty) { container.innerHTML = '<p class="text-center text-slate-500 text-xs">No feedback yet.</p>'; return; }
            container.innerHTML = snap.docs.map(d => {
                const c = d.data();
                return `
                <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800 relative mb-3">
                    <div class="absolute top-4 right-4 text-[9px] text-slate-600 font-mono">${c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleDateString() : 'Just now'}</div>
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-900/30 p-2 rounded-lg"><i data-lucide="user-check" class="w-4 h-4 text-blue-400"></i></div>
                        <div><h4 class="text-xs font-bold text-blue-200 mb-1">Mentor Feedback</h4><p class="text-sm text-slate-300 leading-relaxed">${c.text}</p></div>
                    </div>
                </div>`;
            }).join('');
        });
    }

    // --- TABS & UI HELPERS ---
    window.switchJournalTab = function(tab) {
        journalTab = tab;
        ['active', 'history', 'leaderboard', 'feedback'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            if(btn) btn.className = t===tab ? "px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-blue-400" : "px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300";
        });
        
        document.getElementById('activeTradesList').classList.add('hidden');
        document.getElementById('historyList').classList.add('hidden');
        document.getElementById('leaderboardList').classList.add('hidden');
        document.getElementById('feedbackList').classList.add('hidden');
        
        if(tab==='active') { document.getElementById('activeTradesList').classList.remove('hidden'); renderActiveTrades(); }
        if(tab==='history') { document.getElementById('historyList').classList.remove('hidden'); renderClosedHistory(); }
        if(tab==='leaderboard') { document.getElementById('leaderboardList').classList.remove('hidden'); loadJournalLeaderboard(); }
        if(tab==='feedback') { document.getElementById('feedbackList').classList.remove('hidden'); loadJournalFeedback(); }
    }

    function renderActiveTrades() {
        const active = myTrades.filter(t => t.status==='open' || t.status==='running');
        const container = document.getElementById('activeTradesList');
        if(!container) return;
        
        if(active.length === 0) { container.innerHTML = '<div class="col-span-full py-16 text-center text-slate-500 text-sm font-bold uppercase tracking-wider opacity-50 border-2 border-dashed border-slate-800 rounded-2xl">No Active Positions</div>'; return; }
        
        container.innerHTML = active.map(t => {
            const pnl = Number(t.pnl||0);
            return `
            <div class="glass p-5 rounded-2xl border border-slate-800 relative group hover:border-slate-600 transition-all ${pnl>=0?'shadow-green-900/10':'shadow-red-900/10'} shadow-xl">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-black text-white bg-slate-800 px-2 py-0.5 rounded uppercase tracking-wider">${t.instrument}</span>
                            <span class="text-[10px] font-bold ${t.type==='buy'?'text-green-500':'text-red-500'} bg-slate-950 px-2 py-0.5 rounded uppercase">${t.type}</span>
                        </div>
                        <span class="text-[10px] text-slate-500 font-mono">${t.openTime && t.openTime.seconds ? new Date(t.openTime.seconds*1000).toLocaleDateString() : ''}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black font-mono ${pnl>=0?'text-green-500':'text-red-500'}">${pnl>=0?'+':''}${pnl.toFixed(2)}</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">PnL</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-900/50 p-2 rounded-lg"><p class="text-[10px] text-slate-500 uppercase mb-0.5">Lots</p><p class="font-mono text-xs text-white">${t.lots}</p></div>
                    <div class="bg-slate-900/50 p-2 rounded-lg"><p class="text-[10px] text-slate-500 uppercase mb-0.5">Status</p><p class="font-mono text-xs text-white">${t.status}</p></div>
                </div>
            </div>`;
        }).join('');
    }

    function renderClosedHistory() {
        const history = myTrades.filter(t => t.status==='closed');
        const tbody = document.getElementById('historyTableBody');
        if(!tbody) return;
        
        if(history.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="py-20 text-center text-slate-500 text-sm font-bold uppercase tracking-wider opacity-50">No History Records</td></tr>'; return; }
        
        tbody.innerHTML = history.map(t => {
            const pnl = Number(t.pnl||0);
            return `
            <tr class="hover:bg-slate-800/30 transition-colors border-b border-slate-800/50 last:border-0">
                <td class="p-5 font-bold text-white text-xs">${t.instrument}</td>
                <td class="p-5"><span class="${t.type==='buy'?'text-green-500':'text-red-500'} font-bold text-[10px] uppercase bg-slate-900 px-2 py-1 rounded">${t.type}</span></td>
                <td class="p-5 font-mono text-xs text-slate-300">${t.lots}</td>
                <td class="p-5 text-[10px] font-mono text-slate-400">In: ${t.entryPrice||'-'} <br> Out: ${t.closePrice||'-'}</td>
                <td class="p-5 font-mono text-xs ${Number(t.pips||0)>=0?'text-green-500':'text-red-500'}">${t.pips||0}</td>
                <td class="p-5 text-right font-mono text-sm font-bold ${pnl>=0?'text-green-400':'text-red-400'}">${pnl>0?'+':''}${pnl.toFixed(2)}</td>
                <td class="p-5 text-right text-[10px] text-slate-500">${t.closeTime && t.closeTime.seconds ? new Date(t.closeTime.seconds*1000).toLocaleDateString() : '-'}</td>
            </tr>`;
        }).join('');
    }

    // --- EXPORT CSV ---
    function exportCSV() {
        const rows = [['Time','Asset','Type','Lots','PnL','Status']];
        myTrades.forEach(t => {
            rows.push([
                t.openTime && t.openTime.seconds ? new Date(t.openTime.seconds*1000).toISOString() : '',
                t.instrument||'', t.type||'', t.lots||0, t.pnl||0, t.status||''
            ]);
        });
        const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'trades.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // --- CHART & TICKERS (Simplified for clean integration) ---
    function initActiveSymbols() {
        // Simple websocket for ticker tape
        const ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${DERIV_APP_ID}`);
        ws.onopen = () => ws.send(JSON.stringify({ active_symbols: 'brief', product_type: 'basic' }));
        ws.onmessage = (msg) => {
            const data = JSON.parse(msg.data);
            if(data.active_symbols) {
                const symbols = data.active_symbols.filter(s => s.is_trading === 1).slice(0, 30);
                const container = document.getElementById('tickerContainer');
                if(container) {
                    container.innerHTML = symbols.map(s => `
                        <div class="glass min-w-[120px] p-2 rounded-lg border border-slate-800 flex flex-col justify-center">
                            <p class="text-[9px] font-bold text-slate-500 uppercase truncate">${s.display_name}</p>
                            <p class="text-xs font-black text-blue-100 truncate">${s.symbol}</p>
                        </div>
                    `).join('');
                }
                const select = document.getElementById('liveSymbolSelect');
                if(select) {
                    select.innerHTML = symbols.map(s => `<option value="${s.symbol}">${s.display_name}</option>`).join('');
                }
            }
        };
    }
    
    // Chart toggling
    function toggleChart() {
        const s = document.getElementById('chartSection');
        s.classList.toggle('hidden');
        if(!s.classList.contains('hidden') && !chartInstance) {
            initLightweightChart();
        }
    }

    function initLightweightChart() {
        const container = document.getElementById('tv-container');
        if(!container) return;
        container.innerHTML = '';
        chartInstance = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: 400,
            layout: { backgroundColor: '#0f172a', textColor: '#94a3b8' },
            grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#334155' }
        });
        candleSeries = chartInstance.addCandlestickSeries({
            upColor: '#22c55e', downColor: '#ef4444', borderUpColor: '#22c55e', borderDownColor: '#ef4444', wickUpColor: '#22c55e', wickDownColor: '#ef4444'
        });
        // Dummy data for visual
        const data = [];
        let time = new Date().getTime() / 1000 - 86400;
        let price = 100;
        for(let i=0; i<100; i++) {
            price += (Math.random() - 0.5) * 2;
            data.push({ time: time + i*3600, open: price, high: price+1, low: price-1, close: price+(Math.random()-0.5) });
        }
        candleSeries.setData(data);
    }
    
    function drawEquityCurve(closedTrades) {
        const canvas = document.getElementById('equityCurveCanvas');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.clientWidth;
        const h = canvas.height;
        ctx.clearRect(0,0,w,h);
        
        let equity = 0;
        const points = [0];
        closedTrades.slice().reverse().forEach(t => { equity += (Number(t.pnl)||0); points.push(equity); });
        
        if(points.length < 2) return;
        const min = Math.min(...points);
        const max = Math.max(...points);
        const range = Math.max(1e-8, max - min);
        
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        points.forEach((p, i) => {
            const x = (i / (points.length - 1)) * (w - 10) + 5;
            const y = h - ((p - min) / range) * (h - 10) - 5;
            if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();
    }

  </script>
</body>
</html>
