<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Skillforge Trading Journal — student trading journal and dashboard" />
  <meta name="theme-color" content="#000000" />
  <title>Skillforge Trading Journal</title>
  
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg">

  <!-- Performance: preconnect to third-party resources we'll use -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://unpkg.com" crossorigin />
  <link rel="preconnect" href="https://s3.tradingview.com" crossorigin />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Lucide icons — we'll ask it to create icons after load -->
  <script src="https://unpkg.com/lucide@latest" defer></script>

  <!-- Firebase (compat) - consider migrating to modular SDK for smaller bundles -->
  <!-- kept compat for compatibility with existing app.js; if migrating, update app.js accordingly -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js" defer></script>

  <link rel="stylesheet" href="styles.css?v=4" />
</head>

<body class="pb-10 text-white bg-transparent">
  <!-- Space Background Canvas -->
  <canvas id="space-background" class="fixed inset-0 z-0 pointer-events-none"></canvas>

  <noscript>
    <div class="fixed inset-0 z-[300] flex items-center justify-center bg-red-900/80">
      <div class="max-w-lg p-6 bg-slate-900 rounded-2xl">
        <h2 class="text-lg font-bold">JavaScript required</h2>
        <p class="mt-2 text-sm text-slate-300">This application requires JavaScript to run. Please enable JavaScript in your browser.</p>
      </div>
    </div>
  </noscript>

  <!-- Unified Auth Container (modal-like) -->
  <div id="authContainer" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-950/95 backdrop-blur-xl"
       role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="glass w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl flex flex-col relative border border-slate-700 max-h-[90vh] overflow-y-auto">
      <div class="p-8 pb-0 text-center">
        <img src="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg" alt="Skillforge Logo" class="w-24 h-24 rounded-2xl mb-5 shadow-2xl shadow-blue-900/50 ring-1 ring-white/10 object-cover">
        <h1 id="authTitle" class="text-2xl md:text-3xl font-black tracking-tight mb-1">SKILLFORGE <span class="text-blue-500">DIGITAL</span> &amp; CO. LTD</h1>
        <p class="text-blue-400 text-xs font-bold uppercase tracking-[0.2em]">Official Company</p>
      </div>

      <!-- Landing Options (Step 1) -->
      <div id="landing-options" class="p-8 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <button id="btn-show-login" type="button" class="group p-6 bg-slate-900/50 border border-slate-800 rounded-2xl hover:bg-blue-600 hover:border-blue-500 transition-all text-left">
            <div class="bg-slate-800 group-hover:bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors" aria-hidden="true">
              <i data-lucide="user" class="text-slate-400 group-hover:text-white w-5 h-5"></i>
            </div>
            <h3 class="font-bold text-white text-sm">Student Login</h3>
            <p class="text-[10px] text-slate-500 group-hover:text-blue-200 mt-1">Access your journal</p>
          </button>

          <button id="btn-show-register" type="button" class="group p-6 bg-slate-900/50 border border-slate-800 rounded-2xl hover:bg-blue-600 hover:border-blue-500 transition-all text-left">
            <div class="bg-slate-800 group-hover:bg-white/20 w-10 h-10 rounded-lg flex items-center justify-center mb-3 transition-colors" aria-hidden="true">
              <i data-lucide="user-plus" class="text-slate-400 group-hover:text-white w-5 h-5"></i>
            </div>
            <h3 class="font-bold text-white text-sm">New Student</h3>
            <p class="text-[10px] text-slate-500 group-hover:text-blue-200 mt-1">Create account</p>
          </button>
        </div>

        <div class="relative py-4">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
          <div class="relative flex justify-center"><span class="bg-slate-900 px-2 text-[10px] text-slate-500 uppercase font-bold">Authorized Personnel</span></div>
        </div>

        <button id="btn-show-admin" type="button" class="w-full p-4 rounded-xl border border-slate-800 hover:bg-slate-800 transition-all flex items-center justify-center gap-2 group">
          <i data-lucide="shield-check" class="text-slate-500 group-hover:text-red-500 w-4 h-4 transition-colors" aria-hidden="true"></i>
          <span class="text-xs font-bold text-slate-400 group-hover:text-white uppercase tracking-wider">Mentor Access</span>
        </button>
      </div>

      <!-- Forms Container (Step 2) -->
      <div id="auth-forms" class="p-8 hidden">
        <div class="flex items-center gap-4 mb-6">
          <button id="btn-back-auth" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors" type="button" aria-label="Back">
            <i data-lucide="arrow-left" class="w-5 h-5" aria-hidden="true"></i>
          </button>
          <h2 id="auth-title" class="text-xl font-bold text-white"></h2>
        </div>

        <!-- Student Login/Register Form -->
        <form id="authForm" class="space-y-4 hidden" novalidate>
          <div>
            <label for="email" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Email Address</label>
            <input type="email" id="email" name="email" required aria-required="true" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none transition-colors">
          </div>
          <div>
            <label for="password" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Password</label>
            <div class="relative">
                <input type="password" id="password" name="password" required aria-required="true" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 pr-10 text-white focus:border-blue-500 outline-none transition-colors">
                <button type="button" id="btn-toggle-password" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-colors">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="text-right mt-1">
                <button type="button" id="btn-forgot-password" class="text-[10px] font-bold text-blue-500 hover:text-blue-400 uppercase tracking-wide">Forgot Password?</button>
            </div>
          </div>
          <button type="submit" id="btn-auth-action" class="w-full btn-primary py-3 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg shadow-blue-900/20 mt-2">
            Proceed
          </button>
        </form>

        <!-- Reset Password Form -->
        <form id="resetForm" class="space-y-4 hidden" novalidate>
          <div class="p-4 bg-blue-900/20 border border-blue-900/50 rounded-xl mb-4">
            <p class="text-xs text-blue-200">Enter your email address and we'll send you a link to reset your password.</p>
          </div>
          <div>
            <label for="resetEmail" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Email Address</label>
            <input type="email" id="resetEmail" name="resetEmail" required class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none transition-colors">
          </div>
          <button type="submit" class="w-full btn-primary py-3 rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg shadow-blue-900/20 mt-2">
            Send Reset Link
          </button>
          <button type="button" id="btn-cancel-reset" class="w-full py-3 text-slate-400 hover:text-white font-bold text-xs uppercase tracking-wider">
            Cancel
          </button>
        </form>

        <!-- Admin Passcode Form -->
        <form id="adminForm" class="space-y-4 hidden" novalidate>
          <div>
            <label for="adminPasscode" class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Security Passcode</label>
            <input type="password" id="adminPasscode" name="adminPasscode" placeholder="••••••••••••" required aria-required="true" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center">
          </div>
          <button type="submit" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-sm uppercase tracking-wider shadow-lg shadow-red-900/20 mt-2 transition-all">
            Verify Identity
          </button>
          <p class="text-xs text-slate-400">Mentor/admin passcodes must be verified server-side for security.</p>
        </form>
      </div>
    </div>
  </div>

  <!-- App Content (Hidden until auth) -->
  <div id="appContent" class="hidden relative z-10">
    <header class="glass sticky top-0 z-50 border-b border-slate-800 shadow-2xl">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
          <div class="flex items-center gap-3">
            <img src="https://i.postimg.cc/fRYD4HSw/Whats-App-Image-2026-01-16-at-1-20-06-PM.jpg" alt="Skillforge Logo" class="w-10 h-10 rounded-lg object-cover shadow-lg shadow-blue-900/50">
            <div>
              <h1 class="text-xl md:text-2xl font-extrabold tracking-tight flex items-center gap-2">
                SKILLFORGE <span class="text-blue-500">DIGITAL</span> &amp; CO. LTD
              </h1>
              <p class="text-[10px] uppercase tracking-[0.2em] text-slate-500 font-bold">Student Dashboard</p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900 border border-slate-800 text-xs" role="status" aria-live="polite">
              <div class="live-indicator" aria-hidden="true"></div>
              <span class="text-slate-400 font-medium">LIVE DATA</span>
            </div>

            <button id="btn-toggle-chart" type="button" class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors" title="Toggle Chart" aria-pressed="false">
              <i data-lucide="layout-grid" class="w-5 h-5" aria-hidden="true"></i>
            </button>

            <button id="btn-new-trade" type="button" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
              <i data-lucide="plus-circle" class="w-4 h-4" aria-hidden="true"></i> NEW TRADE
            </button>
            
            <button id="btn-export-csv" type="button" class="px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors">
              <i data-lucide="download" class="w-4 h-4" aria-hidden="true"></i> EXPORT CSV
            </button>

            <button id="btn-logout" type="button" class="p-2 rounded-lg bg-red-900/20 hover:bg-red-900/40 text-red-400 transition-colors" title="Logout">
              <i data-lucide="log-out" class="w-5 h-5" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Market Ticker -->
        <div class="mt-4 flex items-center gap-3">
          <div class="relative w-full max-w-xs">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500" aria-hidden="true"></i>
            <input type="text" id="marketSearch" placeholder="Search Assets..." aria-label="Search assets"
                   class="w-full bg-slate-950 border border-slate-800 rounded-full py-1.5 pl-9 pr-4 text-xs text-white focus:outline-none focus:border-blue-500">
          </div>
          <div id="tickerContainer" class="flex gap-3 overflow-x-auto ticker-scroll flex-1 py-1" aria-live="polite"></div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 mt-8" id="main" tabindex="-1">
      <!-- Chart Section (lazy-loaded when toggled) -->
      <section id="chartSection" class="hidden mb-8" aria-hidden="true">
        <div class="glass rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
          <div class="p-3 bg-slate-900/50 flex justify-between items-center border-b border-slate-800">
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Market Analysis</span>
            <button id="btn-close-chart" type="button" class="text-slate-500 hover:text-white" aria-label="Close Chart">
              <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
            </button>
          </div>
          <div id="tv-container" class="h-[500px]"></div>
        </div>
      </section>

      <!-- Analytics Overview -->
      <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" aria-label="Overview metrics">
        <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Realized PnL</p>
          <h2 id="totalPnl" class="text-2xl font-black font-mono mt-1">$0.00</h2>
        </div>
        <div class="glass p-5 rounded-2xl border-l-4 border-green-500">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Win Rate</p>
          <h2 id="winRate" class="text-2xl font-black font-mono mt-1">0%</h2>
        </div>
        <div class="glass p-5 rounded-2xl border-l-4 border-purple-500">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Total Lots</p>
          <h2 id="totalLots" class="text-2xl font-black font-mono mt-1">0.00</h2>
        </div>
        <div class="glass p-5 rounded-2xl border-l-4 border-slate-500">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Active Trades</p>
          <h2 id="activeCount" class="text-2xl font-black font-mono mt-1">0</h2>
        </div>
      </section>
      
      <section class="mb-8" aria-label="Equity curve">
        <div class="glass rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
          <div class="p-3 bg-slate-900/50 flex justify-between items-center border-b border-slate-800">
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Equity Curve</span>
          </div>
          <div id="equityCurve" class="h-[220px]"></div>
        </div>
      </section>

      <!-- Logging Tabs -->
      <div class="flex flex-wrap gap-2 mb-6 bg-slate-900/50 p-1.5 rounded-2xl w-fit border border-slate-800" role="tablist" aria-label="Views">
        <button onclick="switchTab('active')" id="tab-active" role="tab" aria-selected="true" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-blue-400">Active</button>
        <button onclick="switchTab('history')" id="tab-history" role="tab" aria-selected="false" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Closed</button>
        <button onclick="switchTab('leaderboard')" id="tab-leaderboard" role="tab" aria-selected="false" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Leaderboard</button>
        <button onclick="switchTab('feedback')" id="tab-feedback" role="tab" aria-selected="false" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-slate-300">Feedback</button>
      </div>

      <!-- Views -->
      <div id="activeTradesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" aria-live="polite"></div>

      <div id="historyList" class="hidden overflow-x-auto glass rounded-2xl border border-slate-800" aria-hidden="true">
        <div class="p-4 border-b border-slate-800 bg-slate-900/50 grid grid-cols-1 md:grid-cols-5 gap-3">
          <input id="filterInstrument" placeholder="Instrument" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
          <select id="filterSide" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
            <option value="">Side</option>
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
          </select>
          <input id="filterTag" placeholder="Tag" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
          <input id="filterFrom" type="date" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
          <input id="filterTo" type="date" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-2.5 text-xs text-white outline-none focus:border-blue-500">
        </div>
        <table class="w-full text-left border-collapse">
          <thead class="bg-slate-900/80 text-[10px] uppercase text-slate-400 font-bold border-b border-slate-800">
            <tr>
              <th class="p-5">Instrument</th>
              <th class="p-5">Side</th>
              <th class="p-5">Lots</th>
              <th class="p-5">Entry / Close</th>
              <th class="p-5">Pips</th>
              <th class="p-5 text-right">PnL</th>
              <th class="p-5"></th>
            </tr>
          </thead>
          <tbody id="historyTableBody" class="divide-y divide-slate-800/50"></tbody>
        </table>
      </div>

      <div id="leaderboardList" class="hidden" aria-hidden="true">
        <div class="glass rounded-2xl overflow-hidden border border-slate-800 max-w-2xl mx-auto">
          <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3">
            <i data-lucide="trophy" class="text-yellow-500 w-5 h-5" aria-hidden="true"></i>
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Top Traders</h3>
          </div>
          <div id="leaderboardContent" class="p-5 space-y-3">
            <p class="text-slate-500 text-sm text-center">Loading leaderboard...</p>
          </div>
        </div>
      </div>

      <div id="feedbackList" class="hidden" aria-hidden="true">
        <div class="glass rounded-2xl overflow-hidden border border-slate-800 max-w-2xl mx-auto">
          <div class="p-5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-3">
            <i data-lucide="message-circle" class="text-blue-500 w-5 h-5" aria-hidden="true"></i>
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Instructor Feedback</h3>
          </div>
          <div id="feedbackContent" class="p-5 space-y-4">
            <p class="text-slate-500 text-sm text-center">Loading feedback...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Execution Modal -->
  <div id="tradeModal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md hidden"
       role="dialog" aria-modal="true" aria-labelledby="tradeModalTitle" aria-hidden="true">
    <div class="glass w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border border-slate-700">
      <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
        <h3 id="tradeModalTitle" class="text-sm font-bold text-white tracking-widest uppercase">New Trade Entry</h3>
          <button id="tradeModalClose" type="button" class="text-slate-500 hover:text-white icon-button" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5" aria-hidden="true"></i>
          </button>
      </div>
      <form id="tradeForm" class="p-6 space-y-5" novalidate>
        <div>
          <label for="f-instrument" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Asset Selection</label>
          <div class="relative">
            <select id="f-instrument" name="instrument" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-bold outline-none focus:border-blue-500 appearance-none"></select>
            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none" aria-hidden="true"></i>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Direction</label>
            <div class="flex bg-slate-950 p-1.5 rounded-xl border border-slate-800">
              <button type="button" onclick="setSide('buy')" id="btn-buy" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase bg-green-600 text-white shadow-lg">BUY</button>
              <button type="button" onclick="setSide('sell')" id="btn-sell" class="flex-1 py-2.5 rounded-lg text-[10px] font-black uppercase text-slate-500">SELL</button>
            </div>
          </div>

          <div>
            <label for="f-lots" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Volume (Lots)</label>
            <input type="number" id="f-lots" name="lots" step="0.01" value="0.01" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono text-center outline-none focus:border-blue-500">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="f-entry" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Entry Price</label>
            <input type="number" id="f-entry" name="entry" step="0.00001" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="f-sl" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Stop Loss</label>
            <input type="number" id="f-sl" name="sl" step="0.00001" placeholder="0.00" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="f-tp" class="block text-[10px] font-bold text-slate-500 uppercase mb-2 text-green-500">Take Profit</label>
            <input type="number" id="f-tp" name="tp" step="0.00001" placeholder="0.00" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="f-strategy" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Strategy</label>
            <input type="text" id="f-strategy" name="strategy" placeholder="e.g., Breakout" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="f-setup" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Setup</label>
            <input type="text" id="f-setup" name="setup" placeholder="e.g., 1-2-3" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-blue-500">
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="f-tags" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Tags</label>
            <input type="text" id="f-tags" name="tags" placeholder="comma separated" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-blue-500">
          </div>
          <div>
            <label for="f-riskpct" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Risk %</label>
            <input type="number" id="f-riskpct" name="riskpct" step="0.01" placeholder="1.0" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-blue-500">
          </div>
        </div>
        
        <div>
          <label for="f-notes" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Notes</label>
          <textarea id="f-notes" name="notes" rows="3" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-blue-500" placeholder="plan, emotions, mistakes, improvements"></textarea>
        </div>

        <button type="submit" class="w-full btn-primary py-4 rounded-xl font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:shadow-blue-500/20 mt-4">Execute Trade</button>
      </form>
    </div>
  </div>

  <!-- Edit/Close Modal -->
  <div id="editModal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md hidden"
       role="dialog" aria-modal="true" aria-labelledby="editModalTitle" aria-hidden="true">
    <div class="glass w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border border-slate-700">
      <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
        <h3 id="editModalTitle" class="text-sm font-bold text-white tracking-widest uppercase">Manage Position</h3>
        <button id="editModalClose" type="button" class="text-slate-500 hover:text-white icon-button" aria-label="Close">
          <i data-lucide="x" class="w-5 h-5" aria-hidden="true"></i>
        </button>
      </div>
      <div class="p-6 space-y-5">
        <input type="hidden" id="edit-id">
        <div>
          <label for="e-current-price" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Close Price</label>
          <input type="number" id="e-current-price" step="0.00001" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
        </div>
        <div>
          <label for="e-sl" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Update Stop Loss</label>
          <div class="flex gap-2">
            <input type="number" id="e-sl" step="0.00001" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
            <button type="button" onclick="moveToBE()" class="px-4 bg-blue-600 hover:bg-blue-500 rounded-xl text-[10px] font-bold uppercase text-white whitespace-nowrap transition-colors">Break Even</button>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="flex items-center gap-2">
            <input type="checkbox" id="e-trailing-enable" class="w-4 h-4">
            <label for="e-trailing-enable" class="text-[10px] font-bold text-slate-500 uppercase">Enable Trailing SL</label>
          </div>
          <div>
            <label for="e-trailing-pips" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Trailing Distance (pips)</label>
            <input type="number" id="e-trailing-pips" step="0.1" placeholder="10" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white font-mono outline-none focus:border-blue-500">
          </div>
        </div>
        <div>
          <label for="e-note" class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Add Note</label>
          <textarea id="e-note" rows="2" class="w-full bg-slate-950 border border-slate-800 rounded-xl p-3 text-white outline-none focus:border-blue-500" placeholder="journal your running trade"></textarea>
          <div class="flex gap-3 mt-2">
            <button type="button" onclick="addTradeNote()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-[10px] font-bold uppercase tracking-wider transition-colors">Add Note</button>
          </div>
        </div>
        <div class="flex gap-3 mt-8">
          <button id="btn-update-trade" type="button" onclick="updateTrade()" class="flex-1 py-3.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold text-xs uppercase tracking-wider transition-all">Update SL</button>
          <button id="btn-close-trade" type="button" onclick="confirmCloseTrade()" class="flex-1 py-3.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold text-xs uppercase tracking-wider shadow-lg shadow-red-900/20">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Application JS (deferred). All DOM-dependent initialization should be in app.js -->
  <script src="app.js" defer></script>
  <!-- Boot monitor: if app.js fails to load (e.g., wrong folder), show a visible banner -->
  <script>
    (function () {
      // After parsing, wait briefly; app.js sets window.appInitialized = true on success
      setTimeout(function () {
        if (!window.appInitialized) {
          var banner = document.createElement('div');
          banner.style.position = 'fixed';
          banner.style.top = '0';
          banner.style.left = '0';
          banner.style.right = '0';
          banner.style.zIndex = '1000';
          banner.style.padding = '12px 16px';
          banner.style.background = '#7f1d1d';
          banner.style.color = 'white';
          banner.style.font = 'bold 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter';
          banner.style.textAlign = 'center';
          banner.textContent = 'App failed to initialize: local scripts not found. Open the main index.html from: c:\\Users\\HP\\Documents\\trae_projects\\skillforg registry\\';
          document.body.appendChild(banner);
          console.error('App boot failed — app.js likely missing for this file location. Open the project index.html instead.');
        }
      }, 600);
    })();
  </script>

  <!-- TradingView (defer) - we will lazy-load the heavy widget only when chart is opened -->
  <script>
    // Lazy-loading helper for TradingView. app.js should call `loadTradingView()` when needed.
    window.loadTradingView = async function() {
      if (window.TradingView) return Promise.resolve(window.TradingView);
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://s3.tradingview.com/tv.js';
        s.defer = true;
        s.onload = () => resolve(window.TradingView);
        s.onerror = reject;
        document.head.appendChild(s);
      });
    };
  </script>
  <script>
    window.loadLightweightCharts = async function() {
      if (window.LightweightCharts) return Promise.resolve(window.LightweightCharts);
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js';
        s.defer = true;
        s.onload = () => resolve(window.LightweightCharts);
        s.onerror = reject;
        document.head.appendChild(s);
      });
    };
  </script>

  <!-- Initialize icons once lucide is loaded (Lucide script was loaded with defer so this runs after parsing) -->
  <script>
    // safe call: lucide may be deferred; attempt to create icons when available.
    function ensureLucideIcons() {
      if (window.lucide && typeof window.lucide.createIcons === 'function') {
        window.lucide.createIcons();
      } else {
        // if lucide isn't ready yet, try again shortly
        setTimeout(ensureLucideIcons, 50);
      }
    }
    ensureLucideIcons();
  </script>

  <!-- Added Features: Alarm, Space BG, SW -->
  <script>
    // --- Alarm System ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.value = 880;
        gain.gain.value = 0.1;
        osc.start();
        setTimeout(() => osc.stop(), 200);
    }

    // --- Service Worker ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(() => {
                console.log('ServiceWorker registered');
            }).catch(err => console.log('SW registration failed', err));
        });
    }

    // --- Space Background ---
    function initSpaceBackground() {
        const canvas = document.getElementById('space-background');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let stars = [];
        let planets = [];
        const sun = { x: 0, y: 0, radius: 60, color: '#fbbf24', glow: '#f59e0b' };
        const moon = { x: 0, y: 0, radius: 30, color: '#e2e8f0', glow: '#94a3b8' };
        
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            initStars();
            initPlanets();
        }
        
        function initStars() {
            stars = [];
            for (let i = 0; i < 300; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    radius: Math.random() * 1.5,
                    alpha: Math.random(),
                    speed: Math.random() * 0.05
                });
            }
        }
        
        function initPlanets() {
            planets = [
                { r: 200, angle: 0, speed: 0.002, size: 12, color: '#3b82f6', name: 'Earth' },
                { r: 300, angle: 2, speed: 0.0015, size: 18, color: '#ef4444', name: 'Mars' },
                { r: 450, angle: 4, speed: 0.001, size: 35, color: '#d97706', name: 'Jupiter' },
                { r: 600, angle: 1, speed: 0.0008, size: 30, color: '#eab308', name: 'Saturn' }
            ];
            // Sun position (top left)
            sun.x = width * 0.1;
            sun.y = height * 0.2;
            // Moon relative to earth area but fixed for this animation style
            moon.x = width * 0.8;
            moon.y = height * 0.2;
        }
        
        function draw() {
            // Clear with a deep space gradient
            const grad = ctx.createRadialGradient(width/2, height/2, 0, width/2, height/2, width);
            grad.addColorStop(0, '#0f172a'); // Slate 900
            grad.addColorStop(1, '#020617'); // Slate 950
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, width, height);
            
            // Stars
            ctx.fillStyle = '#ffffff';
            stars.forEach(star => {
                ctx.globalAlpha = star.alpha;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fill();
                star.y -= star.speed;
                if (star.y < 0) star.y = height;
                // Twinkle
                star.alpha += (Math.random() - 0.5) * 0.05;
                if (star.alpha < 0.1) star.alpha = 0.1;
                if (star.alpha > 1) star.alpha = 1;
            });
            ctx.globalAlpha = 1;
            
            // Sun
            ctx.shadowBlur = 50;
            ctx.shadowColor = sun.glow;
            ctx.fillStyle = sun.color;
            ctx.beginPath();
            ctx.arc(sun.x, sun.y, sun.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Moon
            ctx.shadowBlur = 20;
            ctx.shadowColor = moon.glow;
            ctx.fillStyle = moon.color;
            ctx.beginPath();
            ctx.arc(moon.x, moon.y, moon.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // Planets (orbiting center of screen)
            const cx = width / 2;
            const cy = height / 2;
            
            planets.forEach(p => {
                p.angle += p.speed;
                const px = cx + Math.cos(p.angle) * p.r;
                const py = cy + Math.sin(p.angle) * (p.r * 0.5); // Elliptical orbit
                
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(px, py, p.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Rings for Saturn
                if (p.name === 'Saturn') {
                    ctx.strokeStyle = 'rgba(234, 179, 8, 0.5)';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.ellipse(px, py, p.size * 1.8, p.size * 0.5, 0.2, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
            
            requestAnimationFrame(draw);
        }
        
        window.addEventListener('resize', resize);
        resize();
        requestAnimationFrame(draw);
    }
    
    // Start background immediately
    initSpaceBackground();
  </script>
</body>
</html>